-- =============================================
-- Meloten Obfuscator — ИСПРАВЛЕННАЯ ВЕРСИЯ
-- =============================================

-- === ИСПРАВЛЕНИЕ ПУТЕЙ (самое важное) ===
package.path = "./src/?.lua;" ..
               "./src/?/init.lua;" ..
               "./src/prometheus/?.lua;" ..
               "./src/prometheus/?/?.lua;" ..
               package.path

-- === ПОДКЛЮЧЕНИЕ МОДУЛЕЙ ===
local Prometheus = require("prometheus.prometheus")

local ControlFlowFlatten = require("prometheus.steps.ControlFlowFlatten")
local JunkCode           = require("prometheus.steps.JunkCode")
local MelotenHeader      = require("prometheus.steps.MelotenHeader")

-- === НАСТРОЙКИ ===
local preset = Prometheus.Presets.Strong   -- можно поменять на Medium

-- === ГЛАВНАЯ ФУНКЦИЯ ===
local function MelotenObfuscate(inputPath, outputPath)
    local f = assert(io.open(inputPath, "r"))
    local code = f:read("*all")
    f:close()

    print("[Meloten] Запуск обфускации...")

    local pipeline = Prometheus.Pipeline:fromConfig(preset)
    local obfuscated = pipeline:apply(code)

    obfuscated = ControlFlowFlatten:Apply(obfuscated)
    obfuscated = JunkCode:Apply(obfuscated)
    obfuscated = MelotenHeader:Apply(obfuscated)

    local out = assert(io.open(outputPath, "w"))
    out:write(obfuscated)
    out:close()

    print("[Meloten] Готово! Файл сохранён → " .. outputPath)
end

-- Запуск через командную строку
if #arg >= 2 then
    MelotenObfuscate(arg[1], arg[2])
end

return MelotenObfuscate
