-- Meloten Obfuscator v2.1 - УСИЛЕННАЯ ВЕРСИЯ
-- Исправлен Paranoid + Новые техники защиты

-- Настройка путей
package.path = package.path .. ";./src/?.lua;./src/?/init.lua"
local Prometheus = require("prometheus")

local Meloten = {}
Meloten.VERSION = "0.2.0"
Meloten.HEADER = "--[[\n" ..
    "This file was protected using Meloten Obfuscator v" .. Meloten.VERSION .. "\n" ..
    "Bot: https://t.me/Meloten_Obfuscatorbot\n" ..
    "Advanced Multi-Layer Protection Enabled\n" ..
    "]]"

Meloten.Presets = {
    Light = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 20}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = true, Shuffle = true, Rotate = true}},
        }
    },
    
    Medium = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 50}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = false, Shuffle = true, Rotate = true, LocalWrapperTreshold = 1}},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "WrapInFunction"},
        }
    },
    
    Strong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = false, Shuffle = true, Rotate = true, LocalWrapperTreshold = 1}},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    Extreme = {
        LuaVersion = "Lua51",
        VarNamePrefix = "_MLT_",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 999999),
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 200}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1, 
                StringsOnly = false, 
                Shuffle = true, 
                Rotate = true, 
                LocalWrapperTreshold = 1, 
                LocalWrapperArgCount = 3
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    -- Ultra Strong - усиленная защита
    UltraStrong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 9999999),
        Steps = {
            -- Первая волна VM
            {Name = "Vmify", Settings = {IntensityIndex = 150}},
            
            -- Константный массив с усиленными параметрами
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 4,
                LocalWrapperCount = 2,
            }},
            
            -- Проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Разделение строк
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            
            -- Числа в выражения
            {Name = "NumbersToExpressions"},
            
            -- Первое шифрование
            {Name = "EncryptStrings"},
            
            -- Двойная обёртка
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},
            
            -- Вторая волна VM (меньшая интенсивность)
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            
            -- Ещё константный массив для усиления
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
        }
    },
    
    -- Paranoid - ИСПРАВЛЕННАЯ версия (убраны конфликтные настройки)
    Paranoid = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 99999999),
        Steps = {
            -- Первая волна VM с высокой интенсивностью
            {Name = "Vmify", Settings = {IntensityIndex = 200}},
            
            -- Константный массив (УМЕНЬШЕНЫ параметры для стабильности)
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 3,  -- Было 7, теперь 3
                LocalWrapperCount = 2,      -- Было 5, теперь 2
            }},
            
            -- Проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Разделение строк
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            
            -- Числа в выражения
            {Name = "NumbersToExpressions"},
            
            -- Первое шифрование
            {Name = "EncryptStrings"},
            
            -- Тройная обёртка
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},
            
            -- Вторая волна VM
            {Name = "Vmify", Settings = {IntensityIndex = 150}},
            
            -- Ещё константный массив
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Проксирование ещё раз
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Третья волна VM (финальная)
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
        }
    },
    
    -- НОВЫЙ: Insane - Абсолютный максимум (работает стабильно)
    Insane = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 999999999),
        Steps = {
            -- Волна 1: Подготовка
            {Name = "NumbersToExpressions"},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            
            -- Волна 2: Первая VM
            {Name = "Vmify", Settings = {IntensityIndex = 120}},
            
            -- Волна 3: Константы
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 2,
                LocalWrapperCount = 1,
            }},
            
            -- Волна 4: Шифрование
            {Name = "EncryptStrings"},
            
            -- Волна 5: Обёртка
            {Name = "WrapInFunction"},
            
            -- Волна 6: Вторая VM
            {Name = "Vmify", Settings = {IntensityIndex = 120}},
            
            -- Волна 7: Проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 8: Ещё константы
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Волна 9: Вторая обёртка
            {Name = "WrapInFunction"},
            
            -- Волна 10: Третья VM
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            
            -- Волна 11: Финальное проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 12: Третья обёртка
            {Name = "WrapInFunction"},
            
            -- Волна 13: Четвёртая VM (финал)
            {Name = "Vmify", Settings = {IntensityIndex = 80}},
        }
    }
}

function Meloten.obfuscate(code, preset)
    preset = preset or "Medium"
    
    local config = Meloten.Presets[preset]
    if not config then
        error("Invalid preset: " .. preset)
    end
    
    if config.Seed > 0 then
        math.randomseed(config.Seed)
    else
        math.randomseed(os.time())
    end
    
    Prometheus.Logger.logLevel = Prometheus.Logger.LogLevel.Error
    
    local pipeline = Prometheus.Pipeline:fromConfig(config)
    local obfuscated = pipeline:apply(code)
    
    return Meloten.HEADER .. "\n\n" .. obfuscated
end

function Meloten.obfuscateFile(inputPath, outputPath, preset)
    local file = io.open(inputPath, "r")
    if not file then
        error("Cannot open input file: " .. inputPath)
    end
    
    local code = file:read("*all")
    file:close()
    
    local obfuscated = Meloten.obfuscate(code, preset)
    
    file = io.open(outputPath, "w")
    if not file then
        error("Cannot open output file: " .. outputPath)
    end
    
    file:write(obfuscated)
    file:close()
    
    print("✓ Successfully obfuscated: " .. inputPath .. " -> " .. outputPath)
end

return Meloten
