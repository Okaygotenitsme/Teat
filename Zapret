import telebot
import subprocess
import os
import time

# === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"
bot = telebot.TeleBot(TOKEN)

# –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
TEMP_DIR = "temp_files"
if not os.path.exists(TEMP_DIR):
    os.makedirs(TEMP_DIR)

# === –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î ===

@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "üëã –ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ .lua —Ñ–∞–π–ª, –∏ —è –µ–≥–æ –∑–∞—à–∏—Ñ—Ä—É—é —á–µ—Ä–µ–∑ Meloten.")

# === –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í ===

@bot.message_handler(content_types=['document'])
def handle_docs(message):
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ Lua —Ñ–∞–π–ª
        file_name = message.document.file_name
        if not file_name.endswith('.lua'):
            bot.reply_to(message, "‚ùå –≠—Ç–æ –Ω–µ Lua —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .lua")
            return

        status_msg = bot.reply_to(message, "üì• –°–∫–∞—á–∏–≤–∞—é —Ñ–∞–π–ª...")

        # 2. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file_info = bot.get_file(message.document.file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç–∏
        user_id = message.from_user.id
        input_path = os.path.join(TEMP_DIR, f"{user_id}_input.lua")
        output_path = os.path.join(TEMP_DIR, f"{user_id}_obfuscated.lua")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–∏–π —Ñ–∞–π–ª
        with open(input_path, 'wb') as new_file:
            new_file.write(downloaded_file)

        # 3. –ó–ê–ü–£–°–ö–ê–ï–ú LUA –ß–ï–†–ï–ó PYTHON
        bot.edit_message_text(f"‚öôÔ∏è –û–±—Ñ—É—Å–∫–∞—Ü–∏—è (Medium)...", chat_id=message.chat.id, message_id=status_msg.message_id)
        
        # –í–æ—Ç –∑–¥–µ—Å—å –º–∞–≥–∏—è: Python –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∫–æ–Ω—Å–æ–ª–∏
        # "lua run_obfuscator.lua –≤—Ö–æ–¥–Ω–æ–π_—Ñ–∞–π–ª –≤—ã—Ö–æ–¥–Ω–æ–π_—Ñ–∞–π–ª Medium"
        process = subprocess.run(
            ["lua", "run_obfuscator.lua", input_path, output_path, "Medium"],
            capture_output=True,
            text=True
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª Lua —Å–∫—Ä–∏–ø—Ç
        if process.returncode != 0:
            # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞
            error_text = process.stderr or process.stdout # –ß–∏—Ç–∞–µ–º –æ—à–∏–±–∫—É –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ Lua
            bot.reply_to(message, f"‚ùå –û—à–∏–±–∫–∞ –≤ Lua —Å–∫—Ä–∏–ø—Ç–µ:\n{error_text}")
            return

        # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ
        if os.path.exists(output_path):
            bot.edit_message_text(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç...", chat_id=message.chat.id, message_id=status_msg.message_id)
            
            with open(output_path, 'rb') as doc:
                bot.send_document(message.chat.id, doc, caption="‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ Meloten.")
        else:
            bot.reply_to(message, "‚ùå –§–∞–π–ª –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω. –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫.")

    except Exception as e:
        bot.reply_to(message, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –±–æ—Ç–∞: {e}")

    finally:
        # 5. –£–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ (—É–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã)
        if os.path.exists(input_path): os.remove(input_path)
        if os.path.exists(output_path): os.remove(output_path)

# === –ó–ê–ü–£–°–ö ===
print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.polling(none_stop=True)
