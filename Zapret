local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")

local player = Players.LocalPlayer
local Events = ReplicatedStorage:WaitForChild("Events")

-- === ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò ID (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò!) ===
local TEACHER_PRODUCT_ID = 0000000 -- ID –ü—Ä–æ–¥—É–∫—Ç–∞ "One-Time Teacher"
local TEACHER_PASS_ID = 0000000    -- ID –ì–µ–π–º–ø–∞—Å—Å–∞ "Permanent Teacher"

-- === üñºÔ∏è –°–°–´–õ–ö–ò –ù–ê UI ===
local ui = script.Parent

-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —ç–∫—Ä–∞–Ω—ã
local paperFrame = ui:WaitForChild("PaperFrame")
local votingFrame = ui:WaitForChild("VotingFrame")
local winnerFrame = ui:WaitForChild("WinnerFrame")

-- –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ PaperFrame (–õ–∏—Å—Ç–æ–∫)
local topicLabel = paperFrame:WaitForChild("TopicLabel")
local timeLabel = paperFrame:WaitForChild("TimeLabel")
local inputBox = paperFrame:WaitForChild("InputBox")
local submitButton = paperFrame:WaitForChild("SubmitButton")

-- –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ VotingFrame (–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)
local essayShowLabel = votingFrame:WaitForChild("EssayText")
local authorLabel = votingFrame:WaitForChild("AuthorName")
local buttonsContainer = votingFrame:WaitForChild("ButtonsContainer")

-- –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ WinnerFrame (–ü–æ–±–µ–¥–∞)
local winnerTextLabel = winnerFrame:WaitForChild("WinnerText")

-- === üõí –ú–ê–ì–ê–ó–ò–ù –ò –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ ===
-- –ö–Ω–æ–ø–∫–∏ –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ MainUI
local shopButton = ui:WaitForChild("ShopButton")
local afkButton = ui:WaitForChild("AFKButton")
local requestTeacherButton = ui:WaitForChild("RequestTeacherButton") -- –ù–∞–∑–æ–≤–∏ –µ—ë —Ç–∞–∫ –≤ Explorer!

-- –û–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞
local shopFrame = ui:WaitForChild("ShopFrame")
local btnBuyOne = shopFrame:WaitForChild("BtnBuyOne")
local btnBuyPerm = shopFrame:WaitForChild("BtnBuyPerm")
local closeShop = shopFrame:WaitForChild("CloseShop")

-- === üîß –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ===
local isAfk = false
local hasSubmitted = false
local currentSubmitConnection = nil -- –•—Ä–∞–Ω–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –µ–≥–æ

-- –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
paperFrame.Visible = false
votingFrame.Visible = false
winnerFrame.Visible = false
shopFrame.Visible = false

-- === üõçÔ∏è –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê –ò –ú–ï–ù–Æ ===

-- 1. –û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
shopButton.MouseButton1Click:Connect(function()
	shopFrame.Visible = not shopFrame.Visible
end)

closeShop.MouseButton1Click:Connect(function()
	shopFrame.Visible = false
end)

-- 2. –ü–æ–∫—É–ø–∫–∏
btnBuyOne.MouseButton1Click:Connect(function()
	MarketplaceService:PromptProductPurchase(player, TEACHER_PRODUCT_ID)
end)

btnBuyPerm.MouseButton1Click:Connect(function()
	MarketplaceService:PromptGamePassPurchase(player, TEACHER_PASS_ID)
end)

-- 3. –ö–Ω–æ–ø–∫–∞ "–•–æ—á—É –±—ã—Ç—å —É—á–∏—Ç–µ–ª–µ–º"
requestTeacherButton.MouseButton1Click:Connect(function()
	-- –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
	local originalText = requestTeacherButton.Text
	requestTeacherButton.Text = "–ó–∞–ø—Ä–æ—Å..."
	
	Events.RequestTeacher:FireServer()
	
	task.wait(2)
	requestTeacherButton.Text = originalText
end)

-- 4. –†–µ–∂–∏–º AFK
afkButton.MouseButton1Click:Connect(function()
	isAfk = not isAfk
	
	if isAfk then
		afkButton.Text = "AFK: –í–ö–õ"
		-- –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É—à–µ–ª –≤ AFK, —Å–∫—Ä—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—ã–µ –æ–∫–Ω–∞
		paperFrame.Visible = false
		votingFrame.Visible = false
		winnerFrame.Visible = false
	else
		afkButton.Text = "AFK: –í–´–ö–õ"
	end
	
	Events.ToggleAFK:FireServer(isAfk)
end)


-- === üéÆ –õ–û–ì–ò–ö–ê –ò–ì–†–´ ===

-- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏
local function resetSubmitButton()
	if currentSubmitConnection then
		currentSubmitConnection:Disconnect()
		currentSubmitConnection = nil
	end
end

-- 1. –ù–ê–ß–ê–õ–û –†–ê–£–ù–î–ê
Events.StartRound.OnClientEvent:Connect(function(topic)
	-- –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
	resetSubmitButton()
	hasSubmitted = false
	winnerFrame.Visible = false
	votingFrame.Visible = false
	
	-- –ï—Å–ª–∏ –º—ã –ê–§–ö, —Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º (–∫—Ä–æ–º–µ —Å–ª—É—á–∞—è, –µ—Å–ª–∏ –º—ã —Å–ª—É—á–∞–π–Ω–æ —Å—Ç–∞–ª–∏ —É—á–∏—Ç–µ–ª–µ–º)
	if isAfk and topic ~= "TEACHER_MODE" then 
		return 
	end

	-- –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –º—ã –£—á–∏—Ç–µ–ª—å
	if topic == "TEACHER_MODE" then
		paperFrame.Visible = true
		topicLabel.Text = "–í–´ –£–ß–ò–¢–ï–õ–¨! –ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Ç–µ–º—É:"
		submitButton.Text = "–ó–ê–î–ê–¢–¨ –¢–ï–ú–£"
		submitButton.Visible = true
		inputBox.Text = ""
		inputBox.TextEditable = true
		
		-- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –£–ß–ò–¢–ï–õ–Ø
		currentSubmitConnection = submitButton.MouseButton1Click:Connect(function()
			local text = inputBox.Text
			if text == "" then text = "–°–≤–æ–±–æ–¥–Ω–∞—è —Ç–µ–º–∞" end
			
			Events.TeacherSetTopic:FireServer(text)
			
			submitButton.Text = "–¢–µ–º–∞ –∑–∞–¥–∞–Ω–∞!"
			inputBox.TextEditable = false
			task.wait(1)
			paperFrame.Visible = false
		end)
		
	else
		-- –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –£–ß–ï–ù–ò–ö–ê
		paperFrame.Visible = true
		topicLabel.Text = "–¢–µ–º–∞: " .. topic
		submitButton.Text = "–°–î–ê–¢–¨ –†–ê–ë–û–¢–£"
		submitButton.Visible = true
		inputBox.Text = ""
		inputBox.TextEditable = true
		
		-- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –£–ß–ï–ù–ò–ö–ê
		currentSubmitConnection = submitButton.MouseButton1Click:Connect(function()
			if not hasSubmitted then
				hasSubmitted = true
				inputBox.TextEditable = false
				submitButton.Text = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ñ–¥–µ–º..."
				Events.SubmitEssay:FireServer(inputBox.Text)
			end
		end)
	end
end)

-- 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ô–ú–ï–†–ê
Events.TimeUpdate.OnClientEvent:Connect(function(seconds, statusText)
	timeLabel.Text = statusText .. ": " .. tostring(seconds)
	
	-- –ê–≤—Ç–æ—Å–¥–∞—á–∞, –µ—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤)
	if seconds == 0 and paperFrame.Visible and not hasSubmitted then
		-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–µ —É—á–∏—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤–≤–æ–¥–∏—Ç —Ç–µ–º—É (—É —É—á–∏—Ç–µ–ª—è –∫–Ω–æ–ø–∫–∞ "–ó–ê–î–ê–¢–¨ –¢–ï–ú–£")
		if submitButton.Text == "–°–î–ê–¢–¨ –†–ê–ë–û–¢–£" then
			hasSubmitted = true
			inputBox.TextEditable = false
			Events.SubmitEssay:FireServer(inputBox.Text)
		end
		paperFrame.Visible = false
	end
	
	if seconds == 0 then
		paperFrame.Visible = false
	end
end)

-- 3. –ü–û–ö–ê–ó –ß–£–ñ–û–ô –†–ê–ë–û–¢–´ (–ì–û–õ–û–°–û–í–ê–ù–ò–ï)
Events.ShowEssay.OnClientEvent:Connect(function(authorName, text)
	if isAfk then return end -- AFK –Ω–µ –≥–æ–ª–æ—Å—É—é—Ç
	
	paperFrame.Visible = false
	votingFrame.Visible = true
	winnerFrame.Visible = false
	
	essayShowLabel.Text = text
	authorLabel.Text = "–ê–≤—Ç–æ—Ä: " .. authorName
	
	-- –ï—Å–ª–∏ —ç—Ç–æ –º–æ—è —Ä–∞–±–æ—Ç–∞ –∏–ª–∏ —è —É—á–∏—Ç–µ–ª—å - –ø—Ä—è—á–µ–º –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
	-- (–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è –¥–µ–ª–∞–µ—Ç—Å—è –∫–æ—Å–≤–µ–Ω–Ω–æ: –µ—Å–ª–∏ —è –Ω–µ –ø–∏—Å–∞–ª —ç—Å—Å–µ, —è –Ω–µ –≥–æ–ª–æ—Å—É—é –∑–∞ —Å–µ–±—è, –Ω–æ —Ç—É—Ç –ø—Ä–æ—â–µ —Å–∫—Ä—ã—Ç—å –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∞–º)
	if authorName == player.Name then
		buttonsContainer.Visible = false
		authorLabel.Text = "–ê–≤—Ç–æ—Ä: –í–´ (–æ—Ü–µ–Ω–∏–≤–∞—é—Ç –¥—Ä—É–≥–∏–µ)"
	else
		buttonsContainer.Visible = true
	end
end)

-- 4. –ö–ù–û–ü–ö–ò –ì–û–õ–û–°–û–í–ê–ù–ò–Ø (1-10)
for _, btn in pairs(buttonsContainer:GetChildren()) do
	if btn:IsA("TextButton") then
		btn.MouseButton1Click:Connect(function()
			local score = tonumber(btn.Text)
			if score then
				Events.SendVote:FireServer(score)
				buttonsContainer.Visible = false -- –°–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –¥–≤–∞–∂–¥—ã
			end
		end)
	end
end

-- 5. –ü–û–ë–ï–î–ò–¢–ï–õ–¨
Events.ShowWinner.OnClientEvent:Connect(function(winnerText)
	if isAfk then return end
	
	votingFrame.Visible = false
	paperFrame.Visible = false
	winnerFrame.Visible = true
	winnerTextLabel.Text = winnerText
	
	task.wait(5)
	winnerFrame.Visible = false
end)
