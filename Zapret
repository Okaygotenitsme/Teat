-- Meloten Obfuscator v2.0 - ИСПРАВЛЕННАЯ ВЕРСИЯ
-- Новые пресеты: UltraStrong и Paranoid

-- Настройка путей
package.path = package.path .. ";./src/?.lua;./src/?/init.lua"
local Prometheus = require("prometheus")

local Meloten = {}
Meloten.VERSION = "0.1.0"
Meloten.HEADER = "--[[\n" ..
    "This file was protected using Meloten Obfuscator v" .. Meloten.VERSION .. "\n" ..
    "Bot: https://t.me/Meloten_Obfuscatorbot\n" ..
    "]]"

Meloten.Presets = {
    Light = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 20}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = true, Shuffle = true, Rotate = true}},
        }
    },
    
    Medium = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 50}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = false, Shuffle = true, Rotate = true, LocalWrapperTreshold = 1}},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "WrapInFunction"},
        }
    },
    
    Strong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = false, Shuffle = true, Rotate = true, LocalWrapperTreshold = 1}},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    Extreme = {
        LuaVersion = "Lua51",
        VarNamePrefix = "_MLT_",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 999999),
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 200}},
            {Name = "ConstantArray", Settings = {Treshold = 1, StringsOnly = false, Shuffle = true, Rotate = true, LocalWrapperTreshold = 1, LocalWrapperArgCount = 3}},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    -- НОВЫЙ: Ultra Strong - с анти-деобфускацией
    UltraStrong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 9999999),
        Steps = {
            -- Анти-деобфускация (раскомментируйте если step подключён)
            -- {Name = "AntiDeobfuscation", Settings = {deadCodeCount = 10, trapCount = 5, antiPatternCount = 4}},
            
            -- Анти-отладка (раскомментируйте если step подключён)
            -- {Name = "AntiDebug", Settings = {snippetCount = 4}},
            
            -- Многослойное шифрование (раскомментируйте если step подключён)
            -- {Name = "MultiLayerStringEncrypt", Settings = {}},
            
            {Name = "Vmify", Settings = {IntensityIndex = 250}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 5,
                LocalWrapperCount = 3,
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            
            -- Control flow (раскомментируйте если step подключён)
            -- {Name = "ControlFlowFlatten", Settings = {complexity = 8}},
            
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},  -- Двойная обёртка
            {Name = "EncryptStrings"},
        }
    },
    
    -- НОВЫЙ: Paranoid - максимальная защита
    Paranoid = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 99999999),
        Steps = {
            -- Анти-деобфускация на максимум (раскомментируйте если step подключён)
            -- {Name = "AntiDeobfuscation", Settings = {deadCodeCount = 20, trapCount = 10, antiPatternCount = 8}},
            
            -- Анти-отладка (раскомментируйте если step подключён)
            -- {Name = "AntiDebug", Settings = {snippetCount = 4}},
            
            -- Многослойное шифрование (раскомментируйте если step подключён)
            -- {Name = "MultiLayerStringEncrypt", Settings = {}},
            
            {Name = "Vmify", Settings = {IntensityIndex = 300}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 7,
                LocalWrapperCount = 5,
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            
            -- Control flow (раскомментируйте если step подключён)
            -- {Name = "ControlFlowFlatten", Settings = {complexity = 10}},
            
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},  -- Тройная обёртка!
            {Name = "EncryptStrings"},
            {Name = "Vmify", Settings = {IntensityIndex = 100}},  -- Ещё раз VM!
        }
    }  -- ← ВАЖНО: закрываем таблицу Presets
}

function Meloten.obfuscate(code, preset)
    preset = preset or "Medium"
    
    local config = Meloten.Presets[preset]
    if not config then
        error("Invalid preset: " .. preset)
    end
    
    if config.Seed > 0 then
        math.randomseed(config.Seed)
    else
        math.randomseed(os.time())
    end
    
    Prometheus.Logger.logLevel = Prometheus.Logger.LogLevel.Error
    
    local pipeline = Prometheus.Pipeline:fromConfig(config)
    local obfuscated = pipeline:apply(code)
    
    return Meloten.HEADER .. "\n\n" .. obfuscated
end

function Meloten.obfuscateFile(inputPath, outputPath, preset)
    local file = io.open(inputPath, "r")
    if not file then
        error("Cannot open input file: " .. inputPath)
    end
    
    local code = file:read("*all")
    file:close()
    
    local obfuscated = Meloten.obfuscate(code, preset)
    
    file = io.open(outputPath, "w")
    if not file then
        error("Cannot open output file: " .. outputPath)
    end
    
    file:write(obfuscated)
    file:close()
    
    print("✓ Successfully obfuscated: " .. inputPath .. " -> " .. outputPath)
end

return Meloten
