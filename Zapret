import telebot
import subprocess
import os

TOKEN = 'ТВОЙ_ТОКЕН_ОТ_BOTFATHER'
bot = telebot.TeleBot(TOKEN)

@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, "Отправь мне файл .lua, и я его обфусцирую!")

@bot.message_handler(content_types=['document'])
def handle_docs(message):
    if not message.document.file_name.endswith('.lua'):
        bot.reply_to(message, "Ошибка: Принимаются только файлы .lua")
        return

    try:
        # 1. Загружаем файл
        file_info = bot.get_file(message.document.file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        
        input_file = "input.lua"
        output_file = "output.lua"

        with open(input_file, 'wb') as f:
            f.write(downloaded_file)

        bot.send_message(message.chat.id, "⚙️ Запускаю Laufuscator...")

        # 2. Вызываем обфускатор (как указано в README)
        # Мы используем os.path.join, чтобы путь работал и на Windows, и на Linux
        script_path = os.path.join('src', 'obfuscator.lua')
        
        result = subprocess.run(
            ['luau', script_path, input_file, output_file],
            capture_output=True,
            text=True
        )

        # 3. Проверяем результат
        if os.path.exists(output_file):
            with open(output_file, 'rb') as f:
                bot.send_document(message.chat.id, f, caption="✅ Код успешно защищен!")
            os.remove(output_file)
        else:
            bot.reply_to(message, f"❌ Ошибка при создании файла:\n{result.stderr}")
        
        os.remove(input_file)

    except Exception as e:
        bot.reply_to(message, f"⚠️ Произошла ошибка: {str(e)}")

print("Бот запущен и готов к работе...")
bot.polling()
