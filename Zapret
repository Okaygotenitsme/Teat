import os
import tempfile
import subprocess
import logging
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
    ConversationHandler
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
TOKEN = "YOUR_BOT_TOKEN_HERE"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω
LUA_OBFUSCATOR_PATH = "./meloten_cli.lua"  # –ü—É—Ç—å –∫ CLI –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞
TEMP_DIR = "temp_files"

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
WAITING_FOR_FILE, WAITING_FOR_PRESET, WAITING_FOR_URL = range(3)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_stats = {}

# –Ø–∑—ã–∫–∏
LANGUAGES = {
    'ru': {
        'start': 'üî• *Meloten Obfuscator Bot*\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –ø–æ–º–æ–≥—É –∑–∞—â–∏—Ç–∏—Ç—å –≤–∞—à Lua –∫–æ–¥.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥.',
        'help': '''üìö *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*

/start - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
/help - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
/about - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
/presets - –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–µ—Å–µ—Ç–æ–≤ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
/stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/loadstring - –°–æ–∑–¥–∞—Ç—å loadstring —Å –≤–∞—à–µ–π —Å—Å—ã–ª–∫–æ–π
/buy - –ö—É–ø–∏—Ç—å Premium –≤–µ—Ä—Å–∏—é
/language - –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫
/cancel - –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –æ–±—Ñ—É—Å–∫–∞—Ü–∏—é

*–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:*
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ .lua —Ñ–∞–π–ª
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
3. –ü–æ–ª—É—á–∏—Ç–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —Ñ–∞–π–ª!''',
        'about': '''‚ÑπÔ∏è *–û Meloten Obfuscator*

–í–µ—Ä—Å–∏—è: 2.1.0
–û—Å–Ω–æ–≤–∞–Ω –Ω–∞: Prometheus

*–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:*
‚úÖ 8 —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã
‚úÖ VM-based –æ–±—Ñ—É—Å–∫–∞—Ü–∏—è
‚úÖ Anti-Debug –∑–∞—â–∏—Ç–∞
‚úÖ Anti-Deobfuscation
‚úÖ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
‚úÖ Control Flow –∑–∞–ø—É—Ç—ã–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–µ–≥–æ –∫–æ–¥–∞''',
        'presets': '''üéØ *–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã:*

üü¢ *Light* - –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞
‚ö° –ë—ã—Å—Ç—Ä–æ | –†–∞–∑–º–µ—Ä: ~2-3x

üü¢ *Medium* - –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è
‚ö°‚ö° –°—Ä–µ–¥–Ω–µ | –†–∞–∑–º–µ—Ä: ~3-5x

üü° *Strong* - –í—ã—Å–æ–∫–∞—è –∑–∞—â–∏—Ç–∞
‚ö°‚ö°‚ö° –ú–µ–¥–ª–µ–Ω–Ω–µ–µ | –†–∞–∑–º–µ—Ä: ~5-10x

üü° *Extreme* - –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è
‚ö°‚ö°‚ö°‚ö° –ú–µ–¥–ª–µ–Ω–Ω–æ | –†–∞–∑–º–µ—Ä: ~10-20x

üü† *UltraStrong* - –° Anti-Debug
‚ö°‚ö°‚ö°‚ö°‚ö° –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ | –†–∞–∑–º–µ—Ä: ~20-50x

üî¥ *Paranoid* - –ú–∞–∫—Å–∏–º—É–º
üêå –ö—Ä–∞–π–Ω–µ –º–µ–¥–ª–µ–Ω–Ω–æ | –†–∞–∑–º–µ—Ä: ~50-100x

üî¥ *Insane* - –ë–µ–∑—É–º–Ω–∞—è –∑–∞—â–∏—Ç–∞
üêåüêå –û—á–µ–Ω—å –¥–æ–ª–≥–æ | –†–∞–∑–º–µ—Ä: ~100-300x

üî¥ *Nightmare* - –ö–æ—à–º–∞—Ä (Premium)
üêåüêåüêå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–µ–¥–ª–µ–Ω–Ω–æ | –†–∞–∑–º–µ—Ä: ~300-500x''',
        'choose_preset': 'üéØ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏:',
        'send_file': 'üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ .lua —Ñ–∞–π–ª –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏',
        'processing': '‚öôÔ∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–∞–π–ª...\n–ü—Ä–µ—Å–µ—Ç: {preset}\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...',
        'success': '‚úÖ *–û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*\n\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚Ä¢ –í—Ö–æ–¥–Ω–æ–π —Ä–∞–∑–º–µ—Ä: {input_size}\n‚Ä¢ –í—ã—Ö–æ–¥–Ω–æ–π —Ä–∞–∑–º–µ—Ä: {output_size}\n‚Ä¢ –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: {ratio}%\n‚Ä¢ –í—Ä–µ–º—è: {time:.2f} —Å–µ–∫',
        'error': '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:\n`{error}`',
        'cancelled': '‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞',
        'premium_required': '‚≠ê –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /buy –¥–ª—è –ø–æ–∫—É–ø–∫–∏',
        'stats': '''üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*

–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {files}
–í—Å–µ–≥–æ –±–∞–π—Ç: {bytes}
–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å: {joined}
–°—Ç–∞—Ç—É—Å: {status}''',
        'loadstring_prompt': 'üîó –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è loadstring –∫–æ–º–∞–Ω–¥—ã:',
        'loadstring_result': '```lua\nloadstring(game:HttpGet("{url}"))()```\n\nüìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ!',
        'buy': '''‚≠ê *Premium –ø–æ–¥–ø–∏—Å–∫–∞*

*–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Premium:*
‚úÖ –ü—Ä–µ—Å–µ—Ç—ã Insane –∏ Nightmare
‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç —Ñ–∞–π–ª–æ–≤ (50MB)
‚úÖ –ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã
‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚úÖ API –¥–æ—Å—Ç—É–ø

*–¶–µ–Ω–∞:* $9.99/–º–µ—Å—è—Ü

–°–≤—è–∂–∏—Ç–µ—Å—å —Å @YourSupport –¥–ª—è –æ–ø–ª–∞—Ç—ã''',
        'language_changed': '‚úÖ –Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ –†—É—Å—Å–∫–∏–π'
    },
    'en': {
        'start': 'üî• *Meloten Obfuscator Bot*\n\nWelcome! I will help protect your Lua code.\n\nUse /help to see all commands.',
        'help': '''üìö *Available commands:*

/start - Restart the bot
/help - See all bot commands
/about - Information about the bot
/presets - View presets
/stats - See your statistics
/loadstring - Send a link to create loadstring
/buy - Buy premium
/language - Change language
/cancel - Cancel current obfuscation

*How to use:*
1. Send a .lua file
2. Choose obfuscation preset
3. Get your protected file!''',
        'about': '''‚ÑπÔ∏è *About Meloten Obfuscator*

Version: 2.1.0
Based on: Prometheus

*Features:*
‚úÖ 8 protection levels
‚úÖ VM-based obfuscation
‚úÖ Anti-Debug protection
‚úÖ Anti-Deobfuscation
‚úÖ String encryption
‚úÖ Control Flow flattening

Made with ‚ù§Ô∏è to protect your code''',
        'presets': '''üéØ *Available presets:*

üü¢ *Light* - Basic protection
‚ö° Fast | Size: ~2-3x

üü¢ *Medium* - Balanced
‚ö°‚ö° Medium | Size: ~3-5x

üü° *Strong* - High protection
‚ö°‚ö°‚ö° Slower | Size: ~5-10x

üü° *Extreme* - Very high
‚ö°‚ö°‚ö°‚ö° Slow | Size: ~10-20x

üü† *UltraStrong* - With Anti-Debug
‚ö°‚ö°‚ö°‚ö°‚ö° Very slow | Size: ~20-50x

üî¥ *Paranoid* - Maximum
üêå Extremely slow | Size: ~50-100x

üî¥ *Insane* - Insane protection
üêåüêå Very long | Size: ~100-300x

üî¥ *Nightmare* - Nightmare (Premium)
üêåüêåüêå Critically slow | Size: ~300-500x''',
        'choose_preset': 'üéØ Choose obfuscation preset:',
        'send_file': 'üì§ Send a .lua file to obfuscate',
        'processing': '‚öôÔ∏è Processing file...\nPreset: {preset}\nThis may take a while...',
        'success': '‚úÖ *Obfuscation complete!*\n\nüìä Statistics:\n‚Ä¢ Input size: {input_size}\n‚Ä¢ Output size: {output_size}\n‚Ä¢ Ratio: {ratio}%\n‚Ä¢ Time: {time:.2f} sec',
        'error': '‚ùå An error occurred:\n`{error}`',
        'cancelled': '‚ùå Operation cancelled',
        'premium_required': '‚≠ê This feature is available only for Premium users!\n\nUse /buy to purchase',
        'stats': '''üìä *Your statistics:*

Files processed: {files}
Total bytes: {bytes}
Joined: {joined}
Status: {status}''',
        'loadstring_prompt': 'üîó Send a link to create loadstring command:',
        'loadstring_result': '```lua\nloadstring(game:HttpGet("{url}"))()```\n\nüìã Copy and use!',
        'buy': '''‚≠ê *Premium subscription*

*Premium benefits:*
‚úÖ Insane and Nightmare presets
‚úÖ Priority processing
‚úÖ Increased file limit (50MB)
‚úÖ No ads
‚úÖ Extended statistics
‚úÖ API access

*Price:* $9.99/month

Contact @YourSupport for payment''',
        'language_changed': '‚úÖ Language changed to English'
    }
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def init_user_stats(user_id):
    if user_id not in user_stats:
        user_stats[user_id] = {
            'files_processed': 0,
            'total_bytes': 0,
            'joined_date': datetime.now().strftime('%Y-%m-%d'),
            'is_premium': False,
            'language': 'en'
        }

def get_text(user_id, key):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    init_user_stats(user_id)
    lang = user_stats[user_id].get('language', 'en')
    return LANGUAGES.get(lang, LANGUAGES['en']).get(key, key)

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    init_user_stats(user_id)
    
    await update.message.reply_text(
        get_text(user_id, 'start'),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        get_text(user_id, 'help'),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /about
async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        get_text(user_id, 'about'),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /presets
async def presets_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        get_text(user_id, 'presets'),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /stats
async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    init_user_stats(user_id)
    
    stats = user_stats[user_id]
    status = "‚≠ê Premium" if stats['is_premium'] else "üÜì Free"
    
    await update.message.reply_text(
        get_text(user_id, 'stats').format(
            files=stats['files_processed'],
            bytes=stats['total_bytes'],
            joined=stats['joined_date'],
            status=status
        ),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /buy
async def buy_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(
        get_text(user_id, 'buy'),
        parse_mode='Markdown'
    )

# –ö–æ–º–∞–Ω–¥–∞ /language
async def language_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [
            InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data='lang_ru'),
            InlineKeyboardButton("üá¨üáß English", callback_data='lang_en')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üåç Choose your language / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        reply_markup=reply_markup
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    init_user_stats(user_id)
    
    if query.data == 'lang_ru':
        user_stats[user_id]['language'] = 'ru'
        await query.edit_message_text(
            LANGUAGES['ru']['language_changed'],
            parse_mode='Markdown'
        )
    elif query.data == 'lang_en':
        user_stats[user_id]['language'] = 'en'
        await query.edit_message_text(
            LANGUAGES['en']['language_changed'],
            parse_mode='Markdown'
        )

# –ö–æ–º–∞–Ω–¥–∞ /loadstring
async def loadstring_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(get_text(user_id, 'loadstring_prompt'))
    return WAITING_FOR_URL

async def loadstring_url(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    url = update.message.text.strip()
    
    # –°–æ–∑–¥–∞—ë–º loadstring –∫–æ–º–∞–Ω–¥—É
    loadstring_code = f'loadstring(game:HttpGet("{url}"))()'
    
    await update.message.reply_text(
        get_text(user_id, 'loadstring_result').format(url=url),
        parse_mode='Markdown'
    )
    
    return ConversationHandler.END

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    init_user_stats(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ .lua —Ñ–∞–π–ª
    if not update.message.document.file_name.endswith('.lua'):
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ .lua —Ñ–∞–π–ª"
        )
        return ConversationHandler.END
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    context.user_data['file_id'] = update.message.document.file_id
    context.user_data['file_name'] = update.message.document.file_name
    context.user_data['file_size'] = update.message.document.file_size
    
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏
    keyboard = [
        [InlineKeyboardButton("üü¢ Light", callback_data='preset_Light')],
        [InlineKeyboardButton("üü¢ Medium", callback_data='preset_Medium')],
        [InlineKeyboardButton("üü° Strong", callback_data='preset_Strong')],
        [InlineKeyboardButton("üü° Extreme", callback_data='preset_Extreme')],
        [InlineKeyboardButton("üü† UltraStrong", callback_data='preset_UltraStrong')],
        [InlineKeyboardButton("üî¥ Paranoid", callback_data='preset_Paranoid')],
    ]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–º–∏—É–º –ø—Ä–µ—Å–µ—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞
    if user_stats[user_id]['is_premium']:
        keyboard.append([InlineKeyboardButton("üî¥ Insane", callback_data='preset_Insane')])
        keyboard.append([InlineKeyboardButton("üî¥ Nightmare", callback_data='preset_Nightmare')])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        get_text(user_id, 'choose_preset'),
        reply_markup=reply_markup
    )
    
    return WAITING_FOR_PRESET

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ—Å–µ—Ç–∞
async def preset_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    preset = query.data.replace('preset_', '')
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–µ–º–∏—É–º –ø—Ä–µ—Å–µ—Ç—ã
    if preset in ['Insane', 'Nightmare'] and not user_stats[user_id]['is_premium']:
        await query.edit_message_text(get_text(user_id, 'premium_required'))
        return ConversationHandler.END
    
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await query.edit_message_text(
        get_text(user_id, 'processing').format(preset=preset)
    )
    
    # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    os.makedirs(TEMP_DIR, exist_ok=True)
    
    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await context.bot.get_file(context.user_data['file_id'])
        input_path = os.path.join(TEMP_DIR, f"{user_id}_{context.user_data['file_name']}")
        await file.download_to_drive(input_path)
        
        # –ü—É—Ç—å –¥–ª—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        output_path = input_path.replace('.lua', '_obfuscated.lua')
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä
        start_time = datetime.now()
        
        result = subprocess.run(
            ['lua', LUA_OBFUSCATOR_PATH, '--preset', preset, input_path, output_path],
            capture_output=True,
            text=True,
            timeout=300  # 5 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
        )
        
        end_time = datetime.now()
        processing_time = (end_time - start_time).total_seconds()
        
        if result.returncode != 0:
            raise Exception(result.stderr or "Unknown error")
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤
        input_size = os.path.getsize(input_path)
        output_size = os.path.getsize(output_path)
        ratio = (output_size / input_size * 100) if input_size > 0 else 0
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        user_stats[user_id]['files_processed'] += 1
        user_stats[user_id]['total_bytes'] += output_size
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_path, 'rb') as f:
            await context.bot.send_document(
                chat_id=update.effective_chat.id,
                document=f,
                filename=context.user_data['file_name'].replace('.lua', '_obfuscated.lua'),
                caption=get_text(user_id, 'success').format(
                    input_size=f"{input_size/1024:.2f} KB",
                    output_size=f"{output_size/1024:.2f} KB",
                    ratio=f"{ratio:.1f}",
                    time=processing_time
                ),
                parse_mode='Markdown'
            )
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        os.remove(input_path)
        os.remove(output_path)
        
    except Exception as e:
        logger.error(f"Error processing file: {e}")
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=get_text(user_id, 'error').format(error=str(e)),
            parse_mode='Markdown'
        )
        
        # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if os.path.exists(input_path):
            os.remove(input_path)
        if os.path.exists(output_path):
            os.remove(output_path)
    
    return ConversationHandler.END

# –ö–æ–º–∞–Ω–¥–∞ /cancel
async def cancel_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    await update.message.reply_text(get_text(user_id, 'cancelled'))
    return ConversationHandler.END

def main():
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TOKEN).build()
    
    # Conversation handler –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤
    obfuscation_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Document.ALL, handle_file)],
        states={
            WAITING_FOR_PRESET: [CallbackQueryHandler(preset_callback, pattern='^preset_')],
        },
        fallbacks=[CommandHandler('cancel', cancel_command)],
    )
    
    # Conversation handler –¥–ª—è loadstring
    loadstring_handler = ConversationHandler(
        entry_points=[CommandHandler('loadstring', loadstring_command)],
        states={
            WAITING_FOR_URL: [MessageHandler(filters.TEXT & ~filters.COMMAND, loadstring_url)],
        },
        fallbacks=[CommandHandler('cancel', cancel_command)],
    )
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers
    application.add_handler(CommandHandler('start', start_command))
    application.add_handler(CommandHandler('help', help_command))
    application.add_handler(CommandHandler('about', about_command))
    application.add_handler(CommandHandler('presets', presets_command))
    application.add_handler(CommandHandler('stats', stats_command))
    application.add_handler(CommandHandler('buy', buy_command))
    application.add_handler(CommandHandler('language', language_command))
    application.add_handler(CallbackQueryHandler(language_callback, pattern='^lang_'))
    
    application.add_handler(obfuscation_handler)
    application.add_handler(loadstring_handler)
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logger.info("Bot started!")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
