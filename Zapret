import asyncio
import os
import subprocess
from datetime import datetime
from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile, WebAppInfo
from aiogram.client.session.aiohttp import AiohttpSession
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage

# ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================

TOKEN = "YOUR_BOT_TOKEN_HERE"  # ‚Üê –í–°–¢–ê–í–¨–¢–ï –¢–û–ö–ï–ù

session = AiohttpSession(proxy=None)
bot = Bot(token=TOKEN, session=session)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

LUA_PATH = "lua55"
TEMP_DIR = "temp_files"
STATS_FILE = "bot_stats.txt"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
SHOP_ENABLED = True  # –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω
PAYMENT_LINK = "https://t.me/your_payment_bot"  # –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
ADMIN_ID = 123456789  # –í–∞—à Telegram ID –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

if not os.path.exists(TEMP_DIR):
    os.makedirs(TEMP_DIR)

user_files = {}
user_languages = {}
user_stats = {}
premium_users = set()  # –ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

class UserStates(StatesGroup):
    waiting_for_language = State()
    waiting_for_file = State()
    waiting_for_preset = State()

# ================= –¢–ï–ö–°–¢–´ =================

TEXTS = {
    "en": {
        "welcome": (
            "üëã **Welcome to Meloten Obfuscator Bot v2.2!**\n\n"
            "üîê Professional Lua code protection\n"
            "‚ö°Ô∏è 6 protection levels\n"
            "üõ° Ultra-stable, crash-free\n\n"
            "**New in v2.2:**\n"
            "‚Ä¢ ‚úÖ Fixed ALL crashes\n"
            "‚Ä¢ ‚úÖ Stable Paranoid & Insane\n"
            "‚Ä¢ ‚úÖ Optimized for any code\n"
            "‚Ä¢ ‚úÖ 15 layers protection (Insane)\n\n"
            "Send me a `.lua` file to get started!"
        ),
        "select_language": "üåç Select your language:",
        "language_set": "‚úÖ Language set to English",
        "file_received": "‚úÖ File `{filename}` received!\n\nüìä Size: {size} KB\n\nüéØ Select protection level:",
        "wrong_extension": "‚ùå Please send a `.lua` file",
        "processing": "‚öôÔ∏è Processing with **{preset}**...\n\n‚è≥ {layers} protection layers\n‚ö°Ô∏è Please wait...",
        "success": (
            "‚úÖ **Complete!**\n\n"
            "üìä **Stats:**\n"
            "‚Ä¢ Preset: {preset}\n"
            "‚Ä¢ Input: {input_size} KB\n"
            "‚Ä¢ Output: {output_size} KB\n"
            "‚Ä¢ Increase: {ratio}%\n"
            "‚Ä¢ Layers: {layers}\n"
            "‚Ä¢ Time: {time}s\n\n"
            "üóë Files deleted."
        ),
        "help": (
            "üìñ **Meloten Obfuscator v2.2**\n\n"
            "**Commands:**\n"
            "/start - Start bot\n"
            "/help - This help\n"
            "/presets - View presets\n"
            "/stats - Your statistics\n"
            "/buy - Premium features üíé\n"
            "/language - Change language\n"
            "/about - About bot\n\n"
            "**Protection levels:**\n"
            "‚ö°Ô∏è Light - 2 layers\n"
            "‚≠êÔ∏è Medium - 4 layers\n"
            "üîí Strong - 7 layers\n"
            "üõ° Extreme - 7 layers\n"
            "üî• Ultra - 10 layers\n"
            "üíÄ Paranoid - 12 layers\n"
            "üòà Insane - 15 layers"
        ),
        "presets_info": (
            "üéØ **Protection Levels**\n\n"
            "**‚ö°Ô∏è Light**\n"
            "2 layers | +60% size\n"
            "Basic VM + Constants\n\n"
            "**‚≠êÔ∏è Medium** (Recommended)\n"
            "4 layers | +200% size\n"
            "VM + Constants + Proxy + Wrap\n\n"
            "**üîí Strong**\n"
            "7 layers | +500% size\n"
            "+ String split + Encryption\n\n"
            "**üõ° Extreme**\n"
            "7 layers | +900% size\n"
            "+ Enhanced VM\n\n"
            "**üî• Ultra Strong**\n"
            "10 layers | +1200% size\n"
            "Double VM + Double wrap\n\n"
            "**üíÄ Paranoid** (FIXED!)\n"
            "12 layers | +1800% size\n"
            "Triple VM + Triple wrap\n"
            "Stable & powerful\n\n"
            "**üòà Insane** (FIXED!)\n"
            "15 layers | +2500% size\n"
            "Quad VM + 3x Wrap\n"
            "3x Proxy + 3x Constants\n"
            "Maximum protection!"
        ),
        "buy": (
            "üíé **Premium Features**\n\n"
            "üéÅ **What you get:**\n"
            "‚Ä¢ Priority processing (no queue)\n"
            "‚Ä¢ Unlimited file size\n"
            "‚Ä¢ Custom presets\n"
            "‚Ä¢ Lifetime updates\n"
            "‚Ä¢ Premium support\n\n"
            "üí∞ **Pricing:**\n"
            "‚Ä¢ Monthly: $9.99\n"
            "‚Ä¢ Yearly: $79.99 (33% OFF)\n"
            "‚Ä¢ Lifetime: $199.99\n\n"
            "üìß Contact: @your_username\n"
            "üåê Website: your-website.com\n\n"
            "Click button below to purchase!"
        ),
        "about": (
            "‚ÑπÔ∏è **Meloten Obfuscator Bot**\n\n"
            "üîê Version: 2.2 Stable\n"
            "‚ö°Ô∏è Based on: Prometheus\n\n"
            "**v2.2 Features:**\n"
            "‚úÖ 100% Crash-free\n"
            "‚úÖ 15-layer protection\n"
            "‚úÖ Works with any code\n"
            "‚úÖ Ultra-optimized\n\n"
            "Made with ‚ù§Ô∏è for Lua devs\n"
            "Bot: @Meloten_Obfuscatorbot"
        ),
        "stats": (
            "üìä **Your Statistics:**\n\n"
            "üóÇ Files: {count}\n"
            "üìà Input total: {input_total} KB\n"
            "üìä Output total: {output_total} KB\n"
            "‚è± Time: {time_total}s\n"
            "üî• Favorite: {favorite_preset}\n\n"
            "First: {first_use}\n"
            "Last: {last_use}"
        ),
        "no_stats": "üìä No statistics yet!",
        "cancel": "‚ùå Cancelled. Files deleted.",
        "premium_only": "üíé This feature is for Premium users only!\n\nUse /buy to upgrade.",
    },
    "ru": {
        "welcome": (
            "üëã **Meloten Obfuscator Bot v2.2!**\n\n"
            "üîê –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ Lua\n"
            "‚ö°Ô∏è 6 —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã\n"
            "üõ° –£–ª—å—Ç—Ä–∞-—Å—Ç–∞–±–∏–ª—å–Ω—ã–π\n\n"
            "**–ù–æ–≤–æ–µ –≤ v2.2:**\n"
            "‚Ä¢ ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –í–°–ï –∫—Ä–∞—Ö–∏\n"
            "‚Ä¢ ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π Paranoid & Insane\n"
            "‚Ä¢ ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–¥–æ–º\n"
            "‚Ä¢ ‚úÖ 15 —Å–ª–æ—ë–≤ –∑–∞—â–∏—Ç—ã (Insane)\n\n"
            "–û—Ç–ø—Ä–∞–≤—å `.lua` —Ñ–∞–π–ª!"
        ),
        "select_language": "üåç –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        "language_set": "‚úÖ –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π",
        "file_received": "‚úÖ –§–∞–π–ª `{filename}` –ø–æ–ª—É—á–µ–Ω!\n\nüìä –†–∞–∑–º–µ—Ä: {size} –ö–ë\n\nüéØ –í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å:",
        "wrong_extension": "‚ùå –ù—É–∂–µ–Ω `.lua` —Ñ–∞–π–ª",
        "processing": "‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ **{preset}**...\n\n‚è≥ –°–ª–æ—ë–≤: {layers}\n‚ö°Ô∏è –ü–æ–¥–æ–∂–¥–∏...",
        "success": (
            "‚úÖ **–ì–æ—Ç–æ–≤–æ!**\n\n"
            "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
            "‚Ä¢ –ü—Ä–µ—Å–µ—Ç: {preset}\n"
            "‚Ä¢ –í—Ö–æ–¥: {input_size} –ö–ë\n"
            "‚Ä¢ –í—ã—Ö–æ–¥: {output_size} –ö–ë\n"
            "‚Ä¢ –†–æ—Å—Ç: {ratio}%\n"
            "‚Ä¢ –°–ª–æ—ë–≤: {layers}\n"
            "‚Ä¢ –í—Ä–µ–º—è: {time}—Å\n\n"
            "üóë –§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã."
        ),
        "help": (
            "üìñ **Meloten Obfuscator v2.2**\n\n"
            "**–ö–æ–º–∞–Ω–¥—ã:**\n"
            "/start - –ó–∞–ø—É—Å–∫\n"
            "/help - –°–ø—Ä–∞–≤–∫–∞\n"
            "/presets - –ü—Ä–µ—Å–µ—Ç—ã\n"
            "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "/buy - –ü—Ä–µ–º–∏—É–º üíé\n"
            "/language - –Ø–∑—ã–∫\n"
            "/about - –û –±–æ—Ç–µ\n\n"
            "**–£—Ä–æ–≤–Ω–∏:**\n"
            "‚ö°Ô∏è Light - 2 —Å–ª–æ—è\n"
            "‚≠êÔ∏è Medium - 4 —Å–ª–æ—è\n"
            "üîí Strong - 7 —Å–ª–æ—ë–≤\n"
            "üõ° Extreme - 7 —Å–ª–æ—ë–≤\n"
            "üî• Ultra - 10 —Å–ª–æ—ë–≤\n"
            "üíÄ Paranoid - 12 —Å–ª–æ—ë–≤\n"
            "üòà Insane - 15 —Å–ª–æ—ë–≤"
        ),
        "presets_info": (
            "üéØ **–£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã**\n\n"
            "**‚ö°Ô∏è Light**\n"
            "2 —Å–ª–æ—è | +60%\n"
            "–ë–∞–∑–æ–≤–∞—è VM + –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã\n\n"
            "**‚≠êÔ∏è Medium** (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)\n"
            "4 —Å–ª–æ—è | +200%\n"
            "VM + –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã + –ü—Ä–æ–∫—Å–∏ + –û–±—ë—Ä—Ç–∫–∞\n\n"
            "**üîí Strong**\n"
            "7 —Å–ª–æ—ë–≤ | +500%\n"
            "+ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ + –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n\n"
            "**üõ° Extreme**\n"
            "7 —Å–ª–æ—ë–≤ | +900%\n"
            "+ –£—Å–∏–ª–µ–Ω–Ω–∞—è VM\n\n"
            "**üî• Ultra Strong**\n"
            "10 —Å–ª–æ—ë–≤ | +1200%\n"
            "–î–≤–æ–π–Ω–∞—è VM + –î–≤–æ–π–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞\n\n"
            "**üíÄ Paranoid** (–ò–°–ü–†–ê–í–õ–ï–ù!)\n"
            "12 —Å–ª–æ—ë–≤ | +1800%\n"
            "–¢—Ä–æ–π–Ω–∞—è VM + –¢—Ä–æ–π–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞\n"
            "–°—Ç–∞–±–∏–ª—å–Ω–æ –∏ –º–æ—â–Ω–æ\n\n"
            "**üòà Insane** (–ò–°–ü–†–ê–í–õ–ï–ù!)\n"
            "15 —Å–ª–æ—ë–≤ | +2500%\n"
            "4x VM + 3x –û–±—ë—Ä—Ç–∫–∏\n"
            "3x –ü—Ä–æ–∫—Å–∏ + 3x –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã\n"
            "–ú–∞–∫—Å–∏–º—É–º –∑–∞—â–∏—Ç—ã!"
        ),
        "buy": (
            "üíé **–ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏**\n\n"
            "üéÅ **–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—à—å:**\n"
            "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–±–µ–∑ –æ—á–µ—Ä–µ–¥–∏)\n"
            "‚Ä¢ –ë–µ–∑ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞\n"
            "‚Ä¢ –°–≤–æ–∏ –ø—Ä–µ—Å–µ—Ç—ã\n"
            "‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–≤—Å–µ–≥–¥–∞\n"
            "‚Ä¢ –ü—Ä–µ–º–∏—É–º –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
            "üí∞ **–¶–µ–Ω—ã:**\n"
            "‚Ä¢ –ú–µ—Å—è—Ü: $9.99\n"
            "‚Ä¢ –ì–æ–¥: $79.99 (—Å–∫–∏–¥–∫–∞ 33%)\n"
            "‚Ä¢ –ù–∞–≤—Å–µ–≥–¥–∞: $199.99\n\n"
            "üìß –ö–æ–Ω—Ç–∞–∫—Ç: @your_username\n"
            "üåê –°–∞–π—Ç: your-website.com\n\n"
            "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏!"
        ),
        "about": (
            "‚ÑπÔ∏è **Meloten Obfuscator Bot**\n\n"
            "üîê –í–µ—Ä—Å–∏—è: 2.2 –°—Ç–∞–±–∏–ª—å–Ω–∞—è\n"
            "‚ö°Ô∏è –û—Å–Ω–æ–≤–∞: Prometheus\n\n"
            "**v2.2 –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**\n"
            "‚úÖ 100% –±–µ–∑ –∫—Ä–∞—Ö–æ–≤\n"
            "‚úÖ 15-—Å–ª–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞\n"
            "‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º –∫–æ–¥–æ–º\n"
            "‚úÖ –£–ª—å—Ç—Ä–∞-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω\n\n"
            "–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è Lua\n"
            "–ë–æ—Ç: @Meloten_Obfuscatorbot"
        ),
        "stats": (
            "üìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n\n"
            "üóÇ –§–∞–π–ª–æ–≤: {count}\n"
            "üìà –í—Ö–æ–¥ –≤—Å–µ–≥–æ: {input_total} –ö–ë\n"
            "üìä –í—ã—Ö–æ–¥ –≤—Å–µ–≥–æ: {output_total} –ö–ë\n"
            "‚è± –í—Ä–µ–º—è: {time_total}—Å\n"
            "üî• –õ—é–±–∏–º—ã–π: {favorite_preset}\n\n"
            "–ü–µ—Ä–≤—ã–π: {first_use}\n"
            "–ü–æ—Å–ª–µ–¥–Ω–∏–π: {last_use}"
        ),
        "no_stats": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç!",
        "cancel": "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ. –§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã.",
        "premium_only": "üíé –¢–æ–ª—å–∫–æ –¥–ª—è Premium!\n\n–ò—Å–ø–æ–ª—å–∑—É–π /buy –¥–ª—è –ø–æ–∫—É–ø–∫–∏.",
    }
}

PRESET_LAYERS = {
    "Light": 2,
    "Medium": 4,
    "Strong": 7,
    "Extreme": 7,
    "UltraStrong": 10,
    "Paranoid": 12,
    "Insane": 15
}

def get_text(user_id: int, key: str, **kwargs) -> str:
    lang = user_languages.get(user_id, "en")
    text = TEXTS.get(lang, TEXTS["en"]).get(key, TEXTS["en"][key])
    return text.format(**kwargs) if kwargs else text

def update_user_stats(user_id: int, preset: str, input_size: int, output_size: int, time: float):
    if user_id not in user_stats:
        user_stats[user_id] = {
            "count": 0,
            "input_total": 0,
            "output_total": 0,
            "time_total": 0,
            "presets": {},
            "first_use": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "last_use": ""
        }
    
    stats = user_stats[user_id]
    stats["count"] += 1
    stats["input_total"] += input_size
    stats["output_total"] += output_size
    stats["time_total"] += time
    stats["presets"][preset] = stats["presets"].get(preset, 0) + 1
    stats["last_use"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def is_premium(user_id: int) -> bool:
    return user_id in premium_users

def get_language_keyboard():
    buttons = [
        [
            InlineKeyboardButton(text="üá¨üáß English", callback_data="lang_en"),
            InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_presets_keyboard(lang="en"):
    buttons = [
        [
            InlineKeyboardButton(text="‚ö°Ô∏è Light", callback_data="preset_Light"),
            InlineKeyboardButton(text="‚≠êÔ∏è Medium", callback_data="preset_Medium")
        ],
        [
            InlineKeyboardButton(text="üîí Strong", callback_data="preset_Strong"),
            InlineKeyboardButton(text="üõ° Extreme", callback_data="preset_Extreme")
        ],
        [
            InlineKeyboardButton(text="üî• Ultra", callback_data="preset_UltraStrong"),
            InlineKeyboardButton(text="üíÄ Paranoid", callback_data="preset_Paranoid")
        ],
        [
            InlineKeyboardButton(text="üòà Insane", callback_data="preset_Insane")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_buy_keyboard(lang="en"):
    buy_text = "üí≥ Buy Premium" if lang == "en" else "üí≥ –ö—É–ø–∏—Ç—å Premium"
    contact_text = "üìß Contact" if lang == "en" else "üìß –ö–æ–Ω—Ç–∞–∫—Ç"
    
    buttons = [
        [InlineKeyboardButton(text=buy_text, url=PAYMENT_LINK)],
        [InlineKeyboardButton(text=contact_text, url="https://t.me/your_username")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ================= –ö–û–ú–ê–ù–î–´ =================

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    if user_id not in user_languages:
        await message.answer(
            "üåç **Welcome! | –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!**\n\nSelect language | –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
            reply_markup=get_language_keyboard(),
            parse_mode="Markdown"
        )
        await state.set_state(UserStates.waiting_for_language)
    else:
        await message.answer(get_text(user_id, "welcome"), parse_mode="Markdown")

@dp.message(Command("help"))
async def cmd_help(message: types.Message):
    await message.answer(get_text(message.from_user.id, "help"), parse_mode="Markdown")

@dp.message(Command("presets"))
async def cmd_presets(message: types.Message):
    await message.answer(get_text(message.from_user.id, "presets_info"), parse_mode="Markdown")

@dp.message(Command("buy"))
async def cmd_buy(message: types.Message):
    user_id = message.from_user.id
    lang = user_languages.get(user_id, "en")
    
    if is_premium(user_id):
        premium_text = "‚úÖ You already have Premium!" if lang == "en" else "‚úÖ –£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å Premium!"
        await message.answer(premium_text)
        return
    
    await message.answer(
        get_text(user_id, "buy"),
        reply_markup=get_buy_keyboard(lang),
        parse_mode="Markdown"
    )

@dp.message(Command("about"))
async def cmd_about(message: types.Message):
    await message.answer(get_text(message.from_user.id, "about"), parse_mode="Markdown")

@dp.message(Command("language"))
async def cmd_language(message: types.Message, state: FSMContext):
    await message.answer(
        get_text(message.from_user.id, "select_language"),
        reply_markup=get_language_keyboard()
    )
    await state.set_state(UserStates.waiting_for_language)

@dp.message(Command("stats"))
async def cmd_stats(message: types.Message):
    user_id = message.from_user.id
    if user_id not in user_stats or user_stats[user_id]["count"] == 0:
        await message.answer(get_text(user_id, "no_stats"))
        return
    
    stats = user_stats[user_id]
    favorite = max(stats["presets"].items(), key=lambda x: x[1])[0] if stats["presets"] else "N/A"
    
    await message.answer(
        get_text(
            user_id, "stats",
            count=stats["count"],
            input_total=round(stats["input_total"]/1024, 2),
            output_total=round(stats["output_total"]/1024, 2),
            time_total=round(stats["time_total"], 2),
            favorite_preset=favorite,
            first_use=stats["first_use"],
            last_use=stats["last_use"]
        ),
        parse_mode="Markdown"
    )

@dp.message(Command("cancel"))
async def cmd_cancel(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    if user_id in user_files:
        if os.path.exists(user_files[user_id]):
            os.remove(user_files[user_id])
        del user_files[user_id]
    
    await state.clear()
    await message.answer(get_text(user_id, "cancel"))

# ================= CALLBACKS =================

@dp.callback_query(F.data.startswith("lang_"))
async def process_language(callback: types.CallbackQuery, state: FSMContext):
    lang = callback.data.split("_")[1]
    user_id = callback.from_user.id
    user_languages[user_id] = lang
    
    await callback.message.edit_text(get_text(user_id, "language_set"), parse_mode="Markdown")
    await callback.message.answer(get_text(user_id, "welcome"), parse_mode="Markdown")
    await state.clear()
    await callback.answer()

@dp.callback_query(F.data.startswith("preset_"))
async def process_obfuscation(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    preset = callback.data.split("_")[1]
    
    if user_id not in user_files:
        await callback.message.answer(get_text(user_id, "no_file") if user_id in user_languages else "‚ùå No file")
        await callback.answer()
        return
    
    input_path = user_files[user_id]
    output_filename = os.path.basename(input_path).replace(".lua", "_obf.lua")
    output_path = os.path.join(TEMP_DIR, output_filename)
    
    layers = PRESET_LAYERS.get(preset, "?")
    await callback.message.edit_text(
        get_text(user_id, "processing", preset=preset, layers=layers),
        parse_mode="Markdown"
    )
    
    start_time = datetime.now()
    
    try:
        process = await asyncio.create_subprocess_exec(
            LUA_PATH,
            "run_obfuscator.lua",
            input_path,
            output_path,
            preset,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        stdout, stderr = await process.communicate()
        
        if process.returncode != 0:
            error_msg = stderr.decode().strip() or stdout.decode().strip()
            await callback.message.edit_text(f"‚ùå Error:\n```\n{error_msg[:500]}\n```", parse_mode="Markdown")
            return
        
        if os.path.exists(output_path):
            end_time = datetime.now()
            elapsed = (end_time - start_time).total_seconds()
            
            input_size = os.path.getsize(input_path)
            output_size = os.path.getsize(output_path)
            ratio = round((output_size / input_size - 1) * 100, 1) if input_size > 0 else 0
            
            update_user_stats(user_id, preset, input_size, output_size, elapsed)
            
            result_file = FSInputFile(output_path)
            await bot.send_document(
                chat_id=callback.message.chat.id,
                document=result_file,
                caption=get_text(
                    user_id, "success",
                    preset=preset,
                    input_size=round(input_size/1024, 2),
                    output_size=round(output_size/1024, 2),
                    ratio=ratio,
                    layers=layers,
                    time=round(elapsed, 2)
                ),
                parse_mode="Markdown",
                request_timeout=600
            )
            
            del user_files[user_id]
    
    except Exception as e:
        await callback.message.edit_text(f"‚ùå Error: {str(e)}", parse_mode="Markdown")
    finally:
        if os.path.exists(input_path):
            os.remove(input_path)
        if os.path.exists(output_path):
            os.remove(output_path)
    
    await callback.answer()

# ================= –î–û–ö–£–ú–ï–ù–¢–´ =================

@dp.message(F.document)
async def handle_document(message: types.Message):
    user_id = message.from_user.id
    document = message.document
    file_name = document.file_name
    
    if not file_name.endswith(".lua"):
        await message.answer(get_text(user_id, "wrong_extension"))
        return
    
    file_id = document.file_id
    file = await bot.get_file(file_id)
    
    local_filename = f"{user_id}_{file_name}"
    local_path = os.path.join(TEMP_DIR, local_filename)
    
    await bot.download_file(file.file_path, local_path)
    user_files[user_id] = local_path
    
    file_size = round(os.path.getsize(local_path) / 1024, 2)
    
    await message.answer(
        get_text(user_id, "file_received", filename=file_name, size=file_size),
        reply_markup=get_presets_keyboard(user_languages.get(user_id, "en")),
        parse_mode="Markdown"
    )

# ================= –ó–ê–ü–£–°–ö =================

async def main():
    print("üöÄ Meloten Obfuscator Bot v2.2 STABLE started!")
    print("‚úÖ All crashes fixed!")
    print("‚úÖ Paranoid & Insane work perfectly!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüëã Bot stopped")
