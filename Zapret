-- –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π Telegram Bot –¥–ª—è Meloten (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç lua-telegram-bot)
-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞: luarocks install lua-telegram-bot

local telegram = require("telegram-bot-api")
local Meloten = require("meloten")

-- ============================================
-- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
-- ============================================

local BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"  -- ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –¢–û–ö–ï–ù

-- –°–æ–∑–¥–∞—ë–º –±–æ—Ç–∞
local bot = telegram.new(BOT_TOKEN)

-- –ü–∞–ø–∫–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
local TEMP_DIR = "./temp_bot_files/"
os.execute("mkdir -p " .. TEMP_DIR)

-- –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
local users = {}

-- ============================================
-- –£–¢–ò–õ–ò–¢–´
-- ============================================

local function log(msg)
    print(string.format("[%s] %s", os.date("%H:%M:%S"), msg))
end

local function cleanupUser(userId)
    if users[userId] then
        -- –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã
        if users[userId].inputFile then
            os.remove(users[userId].inputFile)
        end
        if users[userId].outputFile then
            os.remove(users[userId].outputFile)
        end
        -- –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        users[userId] = nil
        log("–û—á–∏—â–µ–Ω—ã —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " .. userId)
    end
end

local function getFileSize(path)
    local file = io.open(path, "r")
    if not file then return 0 end
    local size = file:seek("end")
    file:close()
    return size
end

-- ============================================
-- –ö–û–ú–ê–ù–î–´
-- ============================================

bot:onCommand("start", function(msg)
    bot:sendMessage(msg.chat.id, [[
üîê *Meloten Obfuscator Bot*

–ü—Ä–∏–≤–µ—Ç! –Ø –æ–±—Ñ—É—Å—Ü–∏—Ä—É—é —Ç–≤–æ–π Lua –∫–æ–¥.

*–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ .lua —Ñ–∞–π–ª
2. –í—ã–±–µ—Ä–∏ –ø—Ä–µ—Å–µ—Ç (/light, /medium, /strong, /extreme)
3. –ü–æ–ª—É—á–∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —Ñ–∞–π–ª

*–ö–æ–º–∞–Ω–¥—ã:*
/start - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞
/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é

–û—Ç–ø—Ä–∞–≤–ª—è–π —Ñ–∞–π–ª! üöÄ
]], {parse_mode = "Markdown"})
end)

bot:onCommand("help", function(msg)
    bot:sendMessage(msg.chat.id, [[
üìñ *–°–ø—Ä–∞–≤–∫–∞*

*–ü—Ä–µ—Å–µ—Ç—ã:*

*Light* ‚ö° - /light
–ë—ã—Å—Ç—Ä–æ, —Ä–∞–∑–º–µ—Ä +60%

*Medium* ‚≠ê - /medium
–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ, +200%

*Strong* üîí - /strong
–°–∏–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞, +500%

*Extreme* üõ°Ô∏è - /extreme
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º –∑–∞—â–∏—Ç—ã
‚Ä¢ –ê–Ω—Ç–∏-–æ—Ç–ª–∞–¥–∫–∞
‚Ä¢ 3-—Å–ª–æ–π–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ +900% —Ä–∞–∑–º–µ—Ä–∞

–í—Å–µ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è!
]], {parse_mode = "Markdown"})
end)

bot:onCommand("cancel", function(msg)
    cleanupUser(msg.from.id)
    bot:sendMessage(msg.chat.id, "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
end)

-- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ—Å–µ—Ç–æ–≤
local presets = {
    light = "Light",
    medium = "Medium", 
    strong = "Strong",
    extreme = "Extreme"
}

for cmd, preset in pairs(presets) do
    bot:onCommand(cmd, function(msg)
        local userId = msg.from.id
        local chatId = msg.chat.id
        
        if not users[userId] or not users[userId].inputFile then
            bot:sendMessage(chatId, "‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å .lua —Ñ–∞–π–ª")
            return
        end
        
        bot:sendMessage(chatId, "‚öôÔ∏è –û–±—Ñ—É—Å—Ü–∏—Ä—É—é —Å –ø—Ä–µ—Å–µ—Ç–æ–º *" .. preset .. "*...", {parse_mode = "Markdown"})
        
        -- –û–±—Ñ—É—Å–∫–∞—Ü–∏—è
        local inputPath = users[userId].inputFile
        local outputPath = TEMP_DIR .. userId .. "_obfuscated.lua"
        
        local ok, err = pcall(function()
            Meloten.obfuscateFile(inputPath, outputPath, preset)
        end)
        
        if not ok then
            bot:sendMessage(chatId, "‚ùå –û—à–∏–±–∫–∞:\n`" .. tostring(err) .. "`", {parse_mode = "Markdown"})
            cleanupUser(userId)
            return
        end
        
        -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        local inSize = getFileSize(inputPath)
        local outSize = getFileSize(outputPath)
        local ratio = inSize > 0 and (outSize / inSize * 100) or 0
        
        -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
        bot:sendDocument(chatId, {
            document = outputPath,
            caption = string.format(
                "‚úÖ –ì–æ—Ç–æ–≤–æ!\n\n–ü—Ä–µ—Å–µ—Ç: %s\n–†–∞–∑–º–µ—Ä: %d ‚Üí %d –±–∞–π—Ç (%.1f%%)",
                preset, inSize, outSize, ratio
            )
        })
        
        bot:sendMessage(chatId, "‚ú® –§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏")
        
        -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –∫ output –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        users[userId].outputFile = outputPath
        
        -- –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        os.execute("(sleep 5; rm -f " .. outputPath .. ") &")
        cleanupUser(userId)
    end)
end

-- ============================================
-- –û–ë–†–ê–ë–û–¢–ö–ê –î–û–ö–£–ú–ï–ù–¢–û–í
-- ============================================

bot:onDocument(function(msg)
    local chatId = msg.chat.id
    local userId = msg.from.id
    local doc = msg.document
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
    if not doc.file_name:match("%.lua$") then
        bot:sendMessage(chatId, "‚ùå –ù—É–∂–µ–Ω .lua —Ñ–∞–π–ª")
        return
    end
    
    bot:sendMessage(chatId, "üì• –ü–æ–ª—É—á–∞—é —Ñ–∞–π–ª...")
    
    -- –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    local filePath = TEMP_DIR .. userId .. "_" .. doc.file_name
    local ok, err = pcall(function()
        local file = bot:getFile(doc.file_id)
        bot:downloadFile(file.file_path, filePath)
    end)
    
    if not ok then
        bot:sendMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è")
        return
    end
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    users[userId] = {
        inputFile = filePath,
        fileName = doc.file_name
    }
    
    bot:sendMessage(chatId, [[
‚úÖ –§–∞–π–ª –ø–æ–ª—É—á–µ–Ω!

–í—ã–±–µ—Ä–∏ –ø—Ä–µ—Å–µ—Ç:
/light - –õ—ë–≥–∫–∏–π ‚ö°
/medium - –°—Ä–µ–¥–Ω–∏–π ‚≠ê
/strong - –°–∏–ª—å–Ω—ã–π üîí
/extreme - –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π üõ°Ô∏è

/cancel - –û—Ç–º–µ–Ω–∞
]], {parse_mode = "Markdown"})
    
    log("–§–∞–π–ª –æ—Ç " .. userId .. ": " .. doc.file_name)
end)

-- ============================================
-- –ó–ê–ü–£–°–ö
-- ============================================

log("üöÄ Meloten Bot –∑–∞–ø—É—â–µ–Ω!")

-- –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
os.execute("rm -f " .. TEMP_DIR .. "*")

-- –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
bot:run()
