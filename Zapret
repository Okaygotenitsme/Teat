import asyncio
import os
import subprocess
from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile

# ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================

TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"

# ‚ùó –í–ê–ñ–ù–û: –ï—Å–ª–∏ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ [WinError 2],
# –Ω–∞–π–¥–∏ –≥–¥–µ —É —Ç–µ–±—è –ª–µ–∂–∏—Ç lua.exe –∏ –≤–ø–∏—à–∏ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å —Å—é–¥–∞.
# –ù–∞–ø—Ä–∏–º–µ—Ä: r"C:\Program Files\Lua\lua.exe"
# –ï—Å–ª–∏ Lua –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ PATH, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ "lua"
LUA_PATH = "lua" 

TEMP_DIR = "temp_files"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –Ω–µ—Ç
if not os.path.exists(TEMP_DIR):
    os.makedirs(TEMP_DIR)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=TOKEN)
dp = Dispatcher()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∫–∞–∫–æ–π —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–∏–ª —é–∑–µ—Ä
# –§–æ—Ä–º–∞—Ç: { user_id: "–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É" }
user_files = {}

# ================= –ö–õ–ê–í–ò–ê–¢–£–†–´ =================

def get_presets_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–µ—Å–µ—Ç–∞"""
    buttons = [
        [
            InlineKeyboardButton(text="‚ö° Light", callback_data="preset_Light"),
            InlineKeyboardButton(text="‚≠ê Medium", callback_data="preset_Medium")
        ],
        [
            InlineKeyboardButton(text="üîí Strong", callback_data="preset_Strong"),
            InlineKeyboardButton(text="üõ°Ô∏è Extreme", callback_data="preset_Extreme")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ================= –•–ï–ù–î–õ–ï–†–´ (–û–ë–†–ê–ë–û–¢–ß–ò–ö–ò) =================

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer(
        "üëã **–ü—Ä–∏–≤–µ—Ç! –Ø Meloten Obfuscator Bot.**\n\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ `.lua` —Ñ–∞–π–ª, –∏ —è –ø—Ä–µ–¥–ª–æ–∂—É –≤—ã–±—Ä–∞—Ç—å —Å—Ç–µ–ø–µ–Ω—å –∑–∞—â–∏—Ç—ã.",
        parse_mode="Markdown"
    )

@dp.message(F.document)
async def handle_document(message: types.Message):
    document = message.document
    file_name = document.file_name

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    if not file_name.endswith(".lua"):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º `.lua`")
        return

    # 2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    file_id = document.file_id
    file = await bot.get_file(file_id)
    file_path = file.file_path
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å: temp_files/user_id_filename.lua
    local_filename = f"{message.from_user.id}_{file_name}"
    local_path = os.path.join(TEMP_DIR, local_filename)

    await bot.download_file(file_path, local_path)

    # 3. –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ñ–∞–π–ª –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    user_files[message.from_user.id] = local_path

    # 4. –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å –ø—Ä–µ—Å–µ—Ç
    await message.answer(
        f"üìÇ –§–∞–π–ª `{file_name}` –ø–æ–ª—É—á–µ–Ω!\n–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:",
        reply_markup=get_presets_keyboard(),
        parse_mode="Markdown"
    )

@dp.callback_query(F.data.startswith("preset_"))
async def process_obfuscation(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    preset = callback.data.split("_")[1] # –ü–æ–ª—É—á–∞–µ–º "Light", "Medium" –∏ —Ç.–¥.

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    if user_id not in user_files:
        await callback.message.answer("‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–Ω–æ–≤–∞.")
        await callback.answer()
        return

    input_path = user_files[user_id]
    output_filename = os.path.basename(input_path).replace(".lua", "_obf.lua")
    output_path = os.path.join(TEMP_DIR, output_filename)

    await callback.message.edit_text(f"‚öôÔ∏è –ü—Ä–∏–º–µ–Ω—è—é –ø—Ä–µ—Å–µ—Ç **{preset}**...", parse_mode="Markdown")

    # ================= –ó–ê–ü–£–°–ö LUA =================
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º Lua –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å
        # –ö–æ–º–∞–Ω–¥–∞: lua run_obfuscator.lua –≤—Ö–æ–¥ –≤—ã—Ö–æ–¥ –ø—Ä–µ—Å–µ—Ç
        process = await asyncio.create_subprocess_exec(
            LUA_PATH, 
            "run_obfuscator.lua", 
            input_path, 
            output_path, 
            preset,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )

        stdout, stderr = await process.communicate()

        if process.returncode != 0:
            error_msg = stderr.decode().strip() or stdout.decode().strip()
            await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞ Lua:\n`{error_msg}`", parse_mode="Markdown")
            return

        # ================= –û–¢–ü–†–ê–í–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê =================
        if os.path.exists(output_path):
            await callback.message.edit_text("üì§ –ó–∞–≥—Ä—É–∂–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç...")
            
            result_file = FSInputFile(output_path)
            await bot.send_document(
                chat_id=callback.message.chat.id,
                document=result_file,
                caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–µ—Å–µ—Ç: {preset}"
            )
            
            # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞
            del user_files[user_id]
        else:
            await callback.message.edit_text("‚ùå –§–∞–π–ª –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º.")

    except FileNotFoundError:
        # –í–æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–≤–æ–µ–π –æ—à–∏–±–∫–∏ WinError 2
        await callback.message.edit_text(
            f"‚ùå **–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã:** –ù–µ –Ω–∞–π–¥–µ–Ω Lua!\n"
            f"–ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `LUA_PATH` –≤ –∫–æ–¥–µ –±–æ—Ç–∞.\n"
            f"–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: `{LUA_PATH}`",
            parse_mode="Markdown"
        )
    except Exception as e:
        await callback.message.edit_text(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
    
    finally:
        # –ß–∏—Å—Ç–∏–º –º—É—Å–æ—Ä
        if os.path.exists(input_path): os.remove(input_path)
        if os.path.exists(output_path): os.remove(output_path)


# ================= –ó–ê–ü–£–°–ö =================
async def main():
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ aiogram!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
