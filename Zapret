import logging
import asyncio
import os
import re
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import FSInputFile
from aiogram.utils.keyboard import InlineKeyboardBuilder

# === –ò–ú–ü–û–†–¢–´ –ù–ê–®–ò–• –ú–û–î–£–õ–ï–ô ===
# –£–±–µ–¥–∏—Å—å, —á—Ç–æ engine.py –∏ static_decoder.py –ª–µ–∂–∞—Ç –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ —Å –±–æ—Ç–æ–º
from engine import DeobfuscatorEngine
from static_decoder import StaticDecoder 

# === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
API_TOKEN = "–¢–í–û–ô_–¢–û–ö–ï–ù_–ó–î–ï–°–¨"  # <--- –í–°–¢–ê–í–¨ –¢–û–ö–ï–ù –°–Æ–î–ê

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s")
logger = logging.getLogger("LuaDeobfBot")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–∫–∞ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
engine = DeobfuscatorEngine()

# === –•–ï–ù–î–õ–ï–†–´ (–û–ë–†–ê–ë–û–¢–ß–ò–ö–ò) ===

@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    text = (
        "üëã **–ü—Ä–∏–≤–µ—Ç! –Ø Lua Deobfuscator Bot.**\n\n"
        "–Ø —É–º–µ—é —Å–Ω–∏–º–∞—Ç—å –∑–∞—â–∏—Ç—É —Å Lua —Å–∫—Ä–∏–ø—Ç–æ–≤ (Roblox).\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:\n"
        "1. ‚ö° **Static Analysis:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–Ω—è—Ç–∏–µ —Å–ª–∞–±–æ–π –∑–∞—â–∏—Ç—ã (Vexon, Meloten, GarouTe, Base64, XOR).\n"
        "2. üß† **Dynamic Emulation:** –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ (VM) –¥–ª—è –¥–∞–º–ø–∞ —Å–∏–ª—å–Ω—ã—Ö –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–æ–≤ (MoonSec, IronBrew, PSU).\n\n"
        "üìÇ **–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ .lua –∏–ª–∏ .txt —Ñ–∞–π–ª —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º!**"
    )
    await message.answer(text, parse_mode="Markdown")

@dp.message(F.document)
async def handle_document(message: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"""
    user_id = message.from_user.id
    file_name = message.document.file_name
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    if not file_name.endswith(('.lua', '.txt')):
        await message.reply("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .lua –∏–ª–∏ .txt")
        return

    status_msg = await message.reply("‚è≥ **–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...**", parse_mode="Markdown")
    
    # –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
    input_path = f"temp_{user_id}_{file_name}"
    output_path = f"deobf_{user_id}_{file_name}"

    try:
        # 1. –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(message.document.file_id)
        await bot.download_file(file.file_path, input_path)

        # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        with open(input_path, "rb") as f:
            content = f.read()

        # ==========================================================
        # –≠–¢–ê–ü 1: –°–¢–ê–¢–ò–ß–ï–°–ö–ê–Ø –î–ï–û–ë–§–£–°–ö–ê–¶–ò–Ø (–ë–´–°–¢–†–ê–Ø)
        # ==========================================================
        await status_msg.edit_text("‚ö° **–ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä (Static)...**\n_–ü—ã—Ç–∞—é—Å—å –Ω–∞–π—Ç–∏ –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è..._", parse_mode="Markdown")
        
        is_solved, static_code, method_name = StaticDecoder.process(content)
        
        if is_solved:
            # –£–°–ü–ï–•: –°—Ç–∞—Ç–∏–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
            logger.info(f"User {user_id}: Static Success ({method_name})")
            
            header = f"-- [[ DEOBFUSCATED BY STATIC ANALYZER ]]\n-- METHOD: {method_name}\n\n"
            final_data = (header + static_code).encode('utf-8')
            
            with open(output_path, "wb") as f:
                f.write(final_data)
            
            out_file = FSInputFile(output_path)
            await message.answer_document(
                out_file, 
                caption=f"‚úÖ **–£—Å–ø–µ—à–Ω–æ –¥–µ–æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–æ!**\nüõ°Ô∏è –¢–∏–ø –∑–∞—â–∏—Ç—ã: `{method_name}`\n‚ö° –ú–µ—Ç–æ–¥: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
                parse_mode="Markdown"
            )
            await status_msg.delete() # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ
            
            # –ß–∏—Å—Ç–∫–∞ –∏ –≤—ã—Ö–æ–¥
            cleanup([input_path, output_path])
            return

        # ==========================================================
        # –≠–¢–ê–ü 2: –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –≠–ú–£–õ–Ø–¶–ò–Ø (–ï–°–õ–ò –°–¢–ê–¢–ò–ö–ê –ù–ï –ü–û–ú–û–ì–õ–ê)
        # ==========================================================
        await status_msg.edit_text(
            "üß† **–ó–∞–ø—É—Å–∫ —ç–º—É–ª—è—Ç–æ—Ä–∞ (VM)...**\n"
            "_–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ó–∞–ø—É—Å–∫–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É Lua..._\n"
            "_–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 20 —Å–µ–∫—É–Ω–¥._", 
            parse_mode="Markdown"
        )

        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ engine.py
        loop = asyncio.get_event_loop()
        last_update_time = 0
        
        def sync_status_updater(msg):
            # –í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –ª—É—á—à–µ –Ω–µ —Å–ø–∞–º–∏—Ç—å edit_text —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
            pass 

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—è–∂–µ–ª—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        result_data = await asyncio.wait_for(
            loop.run_in_executor(None, engine.process, content, sync_status_updater),
            timeout=120.0 # –¢–∞–π–º–∞—É—Ç 2 –º–∏–Ω—É—Ç—ã
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_path, "wb") as f:
            f.write(result_data)
            
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        caption = "‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**\nüß† –ú–µ—Ç–æ–¥: Dynamic VM Emulation"
        
        if b"[FATAL]" in result_data:
             caption = "‚ö†Ô∏è **–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ.**\n–°–º. —Ñ–∞–π–ª –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."
        elif b"STATIC DEOBFUSCATION SUCCESS" in result_data:
             caption += "\nüõ°Ô∏è –°—Ä–∞–±–æ—Ç–∞–ª –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–µ—Ç–µ–∫—Ç–æ—Ä."
        
        out_file = FSInputFile(output_path)
        await message.answer_document(out_file, caption=caption, parse_mode="Markdown")
        await status_msg.delete()

    except asyncio.TimeoutError:
        await status_msg.edit_text("‚ùå **–û—à–∏–±–∫–∞:** –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–ª—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ (–±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç).")
    except Exception as e:
        logger.error(f"Error processing file: {e}")
        try:
            await status_msg.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
        except: pass
    finally:
        cleanup([input_path, output_path])

def cleanup(files):
    """–£–¥–∞–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"""
    for p in files:
        if os.path.exists(p):
            try: os.remove(p)
            except: pass

async def main():
    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    # –£–¥–∞–ª—è–µ–º –≤–µ–±—Ö—É–∫ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        # –î–ª—è Windows
        if os.name == 'nt':
            asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
