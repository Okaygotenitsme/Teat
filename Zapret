import os
import subprocess
import logging
import time
from pathlib import Path
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
)

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"
LUA_COMMAND = "lua"
OBFUSCATOR_SCRIPT = "./advanced_obfuscator.lua"
TEMP_DIR = "./temp_files"

Path(TEMP_DIR).mkdir(exist_ok=True)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üîí *Advanced Lua Obfuscator Bot*\n\n"
        "üõ°Ô∏è *Protection Level: MAXIMUM*\n"
        "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:\n"
        "‚úÖ Multi-layer VM\n"
        "‚úÖ XOR + Base93 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n"
        "‚úÖ Control flow obfuscation\n"
        "‚úÖ Junk code injection\n"
        "‚úÖ Anti-debug protection\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ .lua —Ñ–∞–π–ª –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏!",
        parse_mode='Markdown'
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üìñ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É .lua —Ñ–∞–π–ª\n"
        "2Ô∏è‚É£ –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏\n"
        "3Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–æ–¥\n\n"
        "‚ö° *–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*\n"
        "‚Ä¢ GoofyScator-level –∑–∞—â–∏—Ç–∞\n"
        "‚Ä¢ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞\n"
        "‚Ä¢ –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n"
        "‚Ä¢ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è\n\n"
        "üîê –í–∞—à –∫–æ–¥ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â—ë–Ω!",
        parse_mode='Markdown'
    )


async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    document = update.message.document
    user_id = update.effective_user.id
    
    if not document.file_name.endswith('.lua'):
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .lua"
        )
        return
    
    status_message = await update.message.reply_text(
        "‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–∞–π–ª...\nüîê –ü—Ä–∏–º–µ–Ω—è—é maximum protection..."
    )
    
    try:
        start_time = time.time()
        
        input_filename = f"{TEMP_DIR}/{user_id}_{document.file_name}"
        output_filename = input_filename.replace('.lua', '_obfuscated.lua')
        
        file = await context.bot.get_file(document.file_id)
        await file.download_to_drive(input_filename)
        
        logger.info(f"Downloaded: {input_filename}")
        
        await status_message.edit_text(
            "üîí –û–±—Ñ—É—Å—Ü–∏—Ä—É—é –∫–æ–¥...\n"
            "‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VM...\n"
            "üîê –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è..."
        )
        
        result = subprocess.run(
            [LUA_COMMAND, OBFUSCATOR_SCRIPT, input_filename, output_filename],
            capture_output=True,
            text=True,
            timeout=60
        )
        
        if result.returncode != 0:
            logger.error(f"Obfuscation error: {result.stderr}")
            await status_message.edit_text(
                f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏:\n```\n{result.stderr[:500]}\n```",
                parse_mode='Markdown'
            )
            return
        
        if not os.path.exists(output_filename):
            await status_message.edit_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª"
            )
            return
        
        processing_time = time.time() - start_time
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤
        original_size = os.path.getsize(input_filename)
        obfuscated_size = os.path.getsize(output_filename)
        
        await status_message.edit_text("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç...")
        
        with open(output_filename, 'rb') as f:
            await update.message.reply_document(
                document=f,
                filename=os.path.basename(output_filename),
                caption=(
                    f"‚úÖ *–û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*\n\n"
                    f"üîê Protection: MAXIMUM\n"
                    f"üìä Original: {original_size} bytes\n"
                    f"üì¶ Obfuscated: {obfuscated_size} bytes\n"
                    f"‚è±Ô∏è Time: {processing_time:.2f}s\n\n"
                    f"üõ°Ô∏è GoofyScator-level protection applied!"
                ),
                parse_mode='Markdown'
            )
        
        await status_message.delete()
        
        logger.info(f"Successfully processed for user {user_id}")
        
    except subprocess.TimeoutExpired:
        await status_message.edit_text(
            "‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π."
        )
        logger.error("Timeout")
        
    except Exception as e:
        await status_message.edit_text(
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"
        )
        logger.error(f"Error: {e}", exc_info=True)
        
    finally:
        for filename in [input_filename, output_filename]:
            try:
                if os.path.exists(filename):
                    os.remove(filename)
                    logger.info(f"Deleted: {filename}")
            except Exception as e:
                logger.error(f"Error deleting {filename}: {e}")


def main():
    if not os.path.exists(OBFUSCATOR_SCRIPT):
        logger.error(f"Obfuscator not found: {OBFUSCATOR_SCRIPT}")
        print(f"‚ùå –§–∞–π–ª {OBFUSCATOR_SCRIPT} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    try:
        result = subprocess.run([LUA_COMMAND, "-v"], capture_output=True)
        logger.info(f"Lua: {result.stdout.decode()}")
    except FileNotFoundError:
        logger.error("Lua not found")
        print(f"‚ùå {LUA_COMMAND} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    application = Application.builder().token(BOT_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    
    logger.info("Bot started with MAXIMUM protection level!")
    print("ü§ñ Advanced Obfuscator Bot –∑–∞–ø—É—â–µ–Ω!")
    print("üõ°Ô∏è Protection Level: GoofyScator")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == '__main__':
    main()
