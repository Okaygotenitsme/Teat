import asyncio
import os
import subprocess
from datetime import datetime
from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, FSInputFile
from aiogram.client.session.aiohttp import AiohttpSession
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage

# ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =================

TOKEN = "YOUR_BOT_TOKEN_HERE"  # ‚Üê –í–°–¢–ê–í–¨–¢–ï –¢–û–ö–ï–ù

session = AiohttpSession(proxy=None)
bot = Bot(token=TOKEN, session=session)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

LUA_PATH = "lua55"  # –∏–ª–∏ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ lua.exe
TEMP_DIR = "temp_files"
STATS_FILE = "bot_stats.txt"

if not os.path.exists(TEMP_DIR):
    os.makedirs(TEMP_DIR)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_files = {}
user_languages = {}  # –Ø–∑—ã–∫ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_stats = {}  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
class UserStates(StatesGroup):
    waiting_for_language = State()
    waiting_for_file = State()
    waiting_for_preset = State()

# ================= –¢–ï–ö–°–¢–´ –ù–ê –†–ê–ó–ù–´–• –Ø–ó–´–ö–ê–• =================

TEXTS = {
    "en": {
        "welcome": (
            "üëã **Welcome to Meloten Obfuscator Bot!**\n\n"
            "üîê Professional Lua code protection\n"
            "‚ö°Ô∏è Multiple obfuscation levels\n"
            "üõ° Anti-debugging & anti-deobfuscation\n\n"
            "**Features:**\n"
            "‚Ä¢ VM-based virtualization\n"
            "‚Ä¢ Multi-layer string encryption\n"
            "‚Ä¢ Control flow flattening\n"
            "‚Ä¢ Dead code injection\n"
            "‚Ä¢ Anti-pattern protection\n\n"
            "Send me a `.lua` file to get started!"
        ),
        "select_language": "üåç Select your language:",
        "language_set": "‚úÖ Language set to English",
        "send_file": "üìÇ Send me a `.lua` file to obfuscate",
        "file_received": "‚úÖ File `{filename}` received!\n\nüìä File size: {size} KB\n\nSelect protection level:",
        "wrong_extension": "‚ùå Please send a `.lua` file",
        "processing": "‚öôÔ∏è Processing with **{preset}** preset...\n\n‚è≥ This may take a while...",
        "success": (
            "‚úÖ **Obfuscation complete!**\n\n"
            "üìä **Statistics:**\n"
            "‚Ä¢ Input size: {input_size} KB\n"
            "‚Ä¢ Output size: {output_size} KB\n"
            "‚Ä¢ Size increase: {ratio}%\n"
            "‚Ä¢ Preset: {preset}\n"
            "‚Ä¢ Time: {time}s\n\n"
            "üóë Files automatically deleted from bot memory."
        ),
        "error_lua": "‚ùå **Lua Error:**\n```\n{error}\n```",
        "error_not_found": "‚ùå Lua interpreter not found!\nCheck LUA_PATH configuration.",
        "error_critical": "‚ùå Critical error: {error}",
        "no_file": "‚ùå No file found. Send a file first!",
        "help": (
            "üìñ **Help - Meloten Obfuscator**\n\n"
            "**Commands:**\n"
            "/start - Start bot\n"
            "/help - Show this help\n"
            "/presets - View all presets\n"
            "/stats - Your statistics\n"
            "/language - Change language\n"
            "/about - About bot\n"
            "/cancel - Cancel operation\n\n"
            "**How to use:**\n"
            "1. Send `.lua` file\n"
            "2. Choose preset\n"
            "3. Get protected file\n\n"
            "**Protection levels:**\n"
            "‚ö°Ô∏è Light - Fast, +60% size\n"
            "‚≠êÔ∏è Medium - Balanced, +200% size\n"
            "üîí Strong - High protection, +500% size\n"
            "üõ° Extreme - Maximum, +900% size\n"
            "üî• Ultra - Anti-deobfuscation, +1200% size\n"
            "üíÄ Paranoid - Absolute protection, +2000% size"
        ),
        "presets_info": (
            "üéØ **Available Presets:**\n\n"
            "**‚ö°Ô∏è Light**\n"
            "‚Ä¢ Basic VM virtualization (20)\n"
            "‚Ä¢ String-only constant array\n"
            "‚Ä¢ Size: +60% | Speed: 1.1x\n"
            "‚Ä¢ Use: Development, testing\n\n"
            "**‚≠êÔ∏è Medium** (Recommended)\n"
            "‚Ä¢ VM virtualization (50)\n"
            "‚Ä¢ Full constant array\n"
            "‚Ä¢ Local proxifying\n"
            "‚Ä¢ Function wrapping\n"
            "‚Ä¢ Size: +200% | Speed: 1.5x\n"
            "‚Ä¢ Use: Regular projects\n\n"
            "**üîí Strong**\n"
            "‚Ä¢ VM virtualization (100)\n"
            "‚Ä¢ All Medium features\n"
            "‚Ä¢ String splitting\n"
            "‚Ä¢ Number expressions\n"
            "‚Ä¢ String encryption\n"
            "‚Ä¢ Size: +500% | Speed: 2.5x\n"
            "‚Ä¢ Use: Commercial projects\n\n"
            "**üõ° Extreme**\n"
            "‚Ä¢ VM virtualization (200)\n"
            "‚Ä¢ All Strong features\n"
            "‚Ä¢ Anti-debugging\n"
            "‚Ä¢ Multi-layer encryption\n"
            "‚Ä¢ Control flow flattening\n"
            "‚Ä¢ Size: +900% | Speed: 4x\n"
            "‚Ä¢ Use: Critical code\n\n"
            "**üî• Ultra Strong** (NEW!)\n"
            "‚Ä¢ VM virtualization (250)\n"
            "‚Ä¢ All Extreme features\n"
            "‚Ä¢ Anti-deobfuscation\n"
            "‚Ä¢ Dead code injection\n"
            "‚Ä¢ Deobfuscator traps\n"
            "‚Ä¢ Size: +1200% | Speed: 6x\n"
            "‚Ä¢ Use: Premium products\n\n"
            "**üíÄ Paranoid** (NEW!)\n"
            "‚Ä¢ VM virtualization (300+100)\n"
            "‚Ä¢ All Ultra features MAXED\n"
            "‚Ä¢ Triple wrapping\n"
            "‚Ä¢ 20+ dead code injections\n"
            "‚Ä¢ 10+ traps\n"
            "‚Ä¢ Size: +2000% | Speed: 10x\n"
            "‚Ä¢ Use: Absolute protection"
        ),
        "stats": (
            "üìä **Your Statistics:**\n\n"
            "üóÇ Files processed: {count}\n"
            "üìà Total input size: {input_total} KB\n"
            "üìä Total output size: {output_total} KB\n"
            "‚è± Total processing time: {time_total}s\n"
            "üî• Most used preset: {favorite_preset}\n\n"
            "First use: {first_use}\n"
            "Last use: {last_use}"
        ),
        "about": (
            "‚ÑπÔ∏è **About Meloten Obfuscator Bot**\n\n"
            "üîê Version: 2.0\n"
            "‚ö°Ô∏è Based on: Prometheus\n"
            "üõ° Enhanced by: Meloten Team\n\n"
            "**Features:**\n"
            "‚Ä¢ 6 protection levels\n"
            "‚Ä¢ Anti-debugging\n"
            "‚Ä¢ Anti-deobfuscation\n"
            "‚Ä¢ Multi-layer encryption\n"
            "‚Ä¢ VM virtualization\n"
            "‚Ä¢ Control flow flattening\n"
            "‚Ä¢ Dead code injection\n\n"
            "**Support:**\n"
            "üìß Contact: @your_username\n"
            "üåê GitHub: github.com/your/repo\n\n"
            "Made with ‚ù§Ô∏è for Lua developers"
        ),
        "cancel": "‚ùå Operation cancelled. Files deleted.",
        "no_stats": "üìä No statistics yet. Process some files first!",
    },
    "ru": {
        "welcome": (
            "üëã **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Meloten Obfuscator Bot!**\n\n"
            "üîê –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ Lua –∫–æ–¥–∞\n"
            "‚ö°Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏\n"
            "üõ° –ê–Ω—Ç–∏-–æ—Ç–ª–∞–¥–∫–∞ & –∞–Ω—Ç–∏-–¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è\n\n"
            "**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è\n"
            "‚Ä¢ –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫\n"
            "‚Ä¢ –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n"
            "‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ –º—É—Å–æ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞\n"
            "‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–æ–≤\n\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ `.lua` —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞!"
        ),
        "select_language": "üåç –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        "language_set": "‚úÖ –Ø–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –†—É—Å—Å–∫–∏–π",
        "send_file": "üìÇ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ `.lua` —Ñ–∞–π–ª –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏",
        "file_received": "‚úÖ –§–∞–π–ª `{filename}` –ø–æ–ª—É—á–µ–Ω!\n\nüìä –†–∞–∑–º–µ—Ä: {size} –ö–ë\n\n–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã:",
        "wrong_extension": "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ `.lua` —Ñ–∞–π–ª",
        "processing": "‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø—Ä–µ—Å–µ—Ç–æ–º **{preset}**...\n\n‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è...",
        "success": (
            "‚úÖ **–û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**\n\n"
            "üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä –≤—Ö–æ–¥–∞: {input_size} –ö–ë\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–∞: {output_size} –ö–ë\n"
            "‚Ä¢ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ: {ratio}%\n"
            "‚Ä¢ –ü—Ä–µ—Å–µ—Ç: {preset}\n"
            "‚Ä¢ –í—Ä–µ–º—è: {time}—Å\n\n"
            "üóë –§–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞."
        ),
        "error_lua": "‚ùå **–û—à–∏–±–∫–∞ Lua:**\n```\n{error}\n```",
        "error_not_found": "‚ùå –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Lua –Ω–µ –Ω–∞–π–¥–µ–Ω!\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É LUA_PATH.",
        "error_critical": "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {error}",
        "no_file": "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª!",
        "help": (
            "üìñ **–°–ø—Ä–∞–≤–∫–∞ - Meloten Obfuscator**\n\n"
            "**–ö–æ–º–∞–Ω–¥—ã:**\n"
            "/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞\n"
            "/help - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
            "/presets - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–µ—Å–µ—Ç—ã\n"
            "/stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "/language - –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫\n"
            "/about - –û –±–æ—Ç–µ\n"
            "/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n\n"
            "**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**\n"
            "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `.lua` —Ñ–∞–π–ª\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç\n"
            "3. –ü–æ–ª—É—á–∏—Ç–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —Ñ–∞–π–ª\n\n"
            "**–£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã:**\n"
            "‚ö°Ô∏è Light - –ë—ã—Å—Ç—Ä–æ, +60% —Ä–∞–∑–º–µ—Ä–∞\n"
            "‚≠êÔ∏è Medium - –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ, +200%\n"
            "üîí Strong - –í—ã—Å–æ–∫–∞—è –∑–∞—â–∏—Ç–∞, +500%\n"
            "üõ° Extreme - –ú–∞–∫—Å–∏–º—É–º, +900%\n"
            "üî• Ultra - –ê–Ω—Ç–∏-–¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è, +1200%\n"
            "üíÄ Paranoid - –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞, +2000%"
        ),
        "presets_info": (
            "üéØ **–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã:**\n\n"
            "**‚ö°Ô∏è Light**\n"
            "‚Ä¢ –ë–∞–∑–æ–≤–∞—è VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (20)\n"
            "‚Ä¢ –ú–∞—Å—Å–∏–≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç—Ä–æ–∫\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +60% | –°–∫–æ—Ä–æ—Å—Ç—å: 1.1x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞, —Ç–µ—Å—Ç—ã\n\n"
            "**‚≠êÔ∏è Medium** (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (50)\n"
            "‚Ä¢ –ü–æ–ª–Ω—ã–π –º–∞—Å—Å–∏–≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç\n"
            "‚Ä¢ –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö\n"
            "‚Ä¢ –û–±—ë—Ä—Ç–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +200% | –°–∫–æ—Ä–æ—Å—Ç—å: 1.5x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –û–±—ã—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã\n\n"
            "**üîí Strong**\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (100)\n"
            "‚Ä¢ –í—Å–µ —Ñ–∏—á–∏ Medium\n"
            "‚Ä¢ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫\n"
            "‚Ä¢ –ß–∏—Å–ª–∞ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏—è\n"
            "‚Ä¢ –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +500% | –°–∫–æ—Ä–æ—Å—Ç—å: 2.5x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ö–æ–º–º–µ—Ä—Ü–∏—è\n\n"
            "**üõ° Extreme**\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (200)\n"
            "‚Ä¢ –í—Å–µ —Ñ–∏—á–∏ Strong\n"
            "‚Ä¢ –ê–Ω—Ç–∏-–æ—Ç–ª–∞–¥–∫–∞\n"
            "‚Ä¢ –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ Control flow flattening\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +900% | –°–∫–æ—Ä–æ—Å—Ç—å: 4x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥\n\n"
            "**üî• Ultra Strong** (–ù–û–í–´–ô!)\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (250)\n"
            "‚Ä¢ –í—Å–µ —Ñ–∏—á–∏ Extreme\n"
            "‚Ä¢ –ê–Ω—Ç–∏-–¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è\n"
            "‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ –º—É—Å–æ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞\n"
            "‚Ä¢ –õ–æ–≤—É—à–∫–∏ –¥–ª—è –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–æ–≤\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +1200% | –°–∫–æ—Ä–æ—Å—Ç—å: 6x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ü—Ä–µ–º–∏—É–º –ø—Ä–æ–¥—É–∫—Ç—ã\n\n"
            "**üíÄ Paranoid** (–ù–û–í–´–ô!)\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è (300+100)\n"
            "‚Ä¢ –í—Å–µ —Ñ–∏—á–∏ Ultra –Ω–∞ –ú–ê–ö–°–ò–ú–£–ú\n"
            "‚Ä¢ –¢—Ä–æ–π–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞\n"
            "‚Ä¢ 20+ –≤—Å—Ç–∞–≤–æ–∫ –º—É—Å–æ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞\n"
            "‚Ä¢ 10+ –ª–æ–≤—É—à–µ–∫\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: +2000% | –°–∫–æ—Ä–æ—Å—Ç—å: 10x\n"
            "‚Ä¢ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∑–∞—â–∏—Ç–∞"
        ),
        "stats": (
            "üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n\n"
            "üóÇ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {count}\n"
            "üìà –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—Ö–æ–¥–∞: {input_total} –ö–ë\n"
            "üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–∞: {output_total} –ö–ë\n"
            "‚è± –û–±—â–µ–µ –≤—Ä–µ–º—è: {time_total}—Å\n"
            "üî• –õ—é–±–∏–º—ã–π –ø—Ä–µ—Å–µ—Ç: {favorite_preset}\n\n"
            "–ü–µ—Ä–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {first_use}\n"
            "–ü–æ—Å–ª–µ–¥–Ω–µ–µ: {last_use}"
        ),
        "about": (
            "‚ÑπÔ∏è **–û Meloten Obfuscator Bot**\n\n"
            "üîê –í–µ—Ä—Å–∏—è: 2.0\n"
            "‚ö°Ô∏è –û—Å–Ω–æ–≤–∞–Ω –Ω–∞: Prometheus\n"
            "üõ° –£–ª—É—á—à–µ–Ω: Meloten Team\n\n"
            "**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n"
            "‚Ä¢ 6 —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã\n"
            "‚Ä¢ –ê–Ω—Ç–∏-–æ—Ç–ª–∞–¥–∫–∞\n"
            "‚Ä¢ –ê–Ω—Ç–∏-–¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è\n"
            "‚Ä¢ –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ\n"
            "‚Ä¢ VM –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è\n"
            "‚Ä¢ Control flow flattening\n"
            "‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ –º—É—Å–æ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞\n\n"
            "**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:**\n"
            "üìß –ö–æ–Ω—Ç–∞–∫—Ç: @your_username\n"
            "üåê GitHub: github.com/your/repo\n\n"
            "–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è Lua —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"
        ),
        "cancel": "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –§–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã.",
        "no_stats": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ —Ñ–∞–π–ª—ã!",
    }
}

# ================= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =================

def get_text(user_id: int, key: str, **kwargs) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    lang = user_languages.get(user_id, "en")
    text = TEXTS.get(lang, TEXTS["en"]).get(key, TEXTS["en"][key])
    return text.format(**kwargs) if kwargs else text

def save_stats():
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ñ–∞–π–ª"""
    with open(STATS_FILE, "w", encoding="utf-8") as f:
        for user_id, stats in user_stats.items():
            f.write(f"{user_id}:{stats}\n")

def load_stats():
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Ñ–∞–π–ª–∞"""
    global user_stats
    if os.path.exists(STATS_FILE):
        with open(STATS_FILE, "r", encoding="utf-8") as f:
            for line in f:
                user_id, stats = line.strip().split(":", 1)
                user_stats[int(user_id)] = eval(stats)

def update_user_stats(user_id: int, preset: str, input_size: int, output_size: int, time: float):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in user_stats:
        user_stats[user_id] = {
            "count": 0,
            "input_total": 0,
            "output_total": 0,
            "time_total": 0,
            "presets": {},
            "first_use": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "last_use": ""
        }
    
    stats = user_stats[user_id]
    stats["count"] += 1
    stats["input_total"] += input_size
    stats["output_total"] += output_size
    stats["time_total"] += time
    stats["presets"][preset] = stats["presets"].get(preset, 0) + 1
    stats["last_use"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    save_stats()

# ================= –ö–õ–ê–í–ò–ê–¢–£–†–´ =================

def get_language_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞"""
    buttons = [
        [
            InlineKeyboardButton(text="üá¨üáß English", callback_data="lang_en"),
            InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_presets_keyboard(lang="en"):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ—Å–µ—Ç–∞"""
    buttons = [
        [
            InlineKeyboardButton(text="‚ö°Ô∏è Light", callback_data="preset_Light"),
            InlineKeyboardButton(text="‚≠êÔ∏è Medium", callback_data="preset_Medium")
        ],
        [
            InlineKeyboardButton(text="üîí Strong", callback_data="preset_Strong"),
            InlineKeyboardButton(text="üõ° Extreme", callback_data="preset_Extreme")
        ],
        [
            InlineKeyboardButton(text="üî• Ultra Strong", callback_data="preset_UltraStrong"),
        ],
        [
            InlineKeyboardButton(text="üíÄ Paranoid", callback_data="preset_Paranoid")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# ================= –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î =================

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
    if user_id not in user_languages:
        await message.answer(
            "üåç **Welcome! | –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!**\n\nSelect your language | –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
            reply_markup=get_language_keyboard(),
            parse_mode="Markdown"
        )
        await state.set_state(UserStates.waiting_for_language)
    else:
        await message.answer(
            get_text(user_id, "welcome"),
            parse_mode="Markdown"
        )

@dp.message(Command("help"))
async def cmd_help(message: types.Message):
    await message.answer(
        get_text(message.from_user.id, "help"),
        parse_mode="Markdown"
    )

@dp.message(Command("presets"))
async def cmd_presets(message: types.Message):
    await message.answer(
        get_text(message.from_user.id, "presets_info"),
        parse_mode="Markdown"
    )

@dp.message(Command("stats"))
async def cmd_stats(message: types.Message):
    user_id = message.from_user.id
    
    if user_id not in user_stats or user_stats[user_id]["count"] == 0:
        await message.answer(get_text(user_id, "no_stats"))
        return
    
    stats = user_stats[user_id]
    favorite = max(stats["presets"].items(), key=lambda x: x[1])[0] if stats["presets"] else "N/A"
    
    await message.answer(
        get_text(
            user_id, "stats",
            count=stats["count"],
            input_total=round(stats["input_total"] / 1024, 2),
            output_total=round(stats["output_total"] / 1024, 2),
            time_total=round(stats["time_total"], 2),
            favorite_preset=favorite,
            first_use=stats["first_use"],
            last_use=stats["last_use"]
        ),
        parse_mode="Markdown"
    )

@dp.message(Command("about"))
async def cmd_about(message: types.Message):
    await message.answer(
        get_text(message.from_user.id, "about"),
        parse_mode="Markdown"
    )

@dp.message(Command("language"))
async def cmd_language(message: types.Message, state: FSMContext):
    await message.answer(
        get_text(message.from_user.id, "select_language"),
        reply_markup=get_language_keyboard()
    )
    await state.set_state(UserStates.waiting_for_language)

@dp.message(Command("cancel"))
async def cmd_cancel(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã
    if user_id in user_files:
        if os.path.exists(user_files[user_id]):
            os.remove(user_files[user_id])
        del user_files[user_id]
    
    await state.clear()
    await message.answer(get_text(user_id, "cancel"))

# ================= –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò CALLBACK =================

@dp.callback_query(F.data.startswith("lang_"))
async def process_language(callback: types.CallbackQuery, state: FSMContext):
    lang = callback.data.split("_")[1]
    user_id = callback.from_user.id
    user_languages[user_id] = lang
    
    await callback.message.edit_text(
        get_text(user_id, "language_set"),
        parse_mode="Markdown"
    )
    
    await callback.message.answer(
        get_text(user_id, "welcome"),
        parse_mode="Markdown"
    )
    
    await state.clear()
    await callback.answer()

@dp.callback_query(F.data.startswith("preset_"))
async def process_obfuscation(callback: types.CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id
    preset = callback.data.split("_")[1]
    
    if user_id not in user_files:
        await callback.message.answer(get_text(user_id, "no_file"))
        await callback.answer()
        return
    
    input_path = user_files[user_id]
    output_filename = os.path.basename(input_path).replace(".lua", "_obf.lua")
    output_path = os.path.join(TEMP_DIR, output_filename)
    
    await callback.message.edit_text(
        get_text(user_id, "processing", preset=preset),
        parse_mode="Markdown"
    )
    
    start_time = datetime.now()
    
    try:
        # –ó–∞–ø—É—Å–∫ Lua –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞
        process = await asyncio.create_subprocess_exec(
            LUA_PATH,
            "run_obfuscator.lua",
            input_path,
            output_path,
            preset,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE
        )
        
        stdout, stderr = await process.communicate()
        
        if process.returncode != 0:
            error_msg = stderr.decode().strip() or stdout.decode().strip()
            await callback.message.edit_text(
                get_text(user_id, "error_lua", error=error_msg[:500]),
                parse_mode="Markdown"
            )
            return
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if os.path.exists(output_path):
            end_time = datetime.now()
            elapsed = (end_time - start_time).total_seconds()
            
            input_size = os.path.getsize(input_path)
            output_size = os.path.getsize(output_path)
            ratio = round((output_size / input_size - 1) * 100, 1) if input_size > 0 else 0
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            update_user_stats(user_id, preset, input_size, output_size, elapsed)
            
            result_file = FSInputFile(output_path)
            await bot.send_document(
                chat_id=callback.message.chat.id,
                document=result_file,
                caption=get_text(
                    user_id, "success",
                    input_size=round(input_size / 1024, 2),
                    output_size=round(output_size / 1024, 2),
                    ratio=ratio,
                    preset=preset,
                    time=round(elapsed, 2)
                ),
                parse_mode="Markdown",
                request_timeout=600
            )
            
            del user_files[user_id]
        else:
            await callback.message.edit_text(get_text(user_id, "error_critical", error="Output file not created"))
    
    except FileNotFoundError:
        await callback.message.edit_text(
            get_text(user_id, "error_not_found"),
            parse_mode="Markdown"
        )
    except Exception as e:
        await callback.message.edit_text(
            get_text(user_id, "error_critical", error=str(e)),
            parse_mode="Markdown"
        )
    finally:
        # –û—á–∏—Å—Ç–∫–∞
        if os.path.exists(input_path):
            os.remove(input_path)
        if os.path.exists(output_path):
            os.remove(output_path)
    
    await callback.answer()

# ================= –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–û–ö–£–ú–ï–ù–¢–û–í =================

@dp.message(F.document)
async def handle_document(message: types.Message):
    user_id = message.from_user.id
    document = message.document
    file_name = document.file_name
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    if not file_name.endswith(".lua"):
        await message.answer(get_text(user_id, "wrong_extension"))
        return
    
    # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    file_id = document.file_id
    file = await bot.get_file(file_id)
    file_path = file.file_path
    
    local_filename = f"{user_id}_{file_name}"
    local_path = os.path.join(TEMP_DIR, local_filename)
    
    await bot.download_file(file_path, local_path)
    
    user_files[user_id] = local_path
    
    file_size = round(os.path.getsize(local_path) / 1024, 2)
    
    await message.answer(
        get_text(user_id, "file_received", filename=file_name, size=file_size),
        reply_markup=get_presets_keyboard(user_languages.get(user_id, "en")),
        parse_mode="Markdown"
    )

# ================= –ó–ê–ü–£–°–ö =================

async def main():
    print("üöÄ Meloten Obfuscator Bot v2.0 started!")
    load_stats()
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüëã Bot stopped")
        save_stats()
