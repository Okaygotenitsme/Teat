-- Meloten Obfuscator v2.2 - СТАБИЛЬНАЯ ВЕРСИЯ
-- Исправлены все крахи, оптимизированы настройки

package.path = package.path .. ";./src/?.lua;./src/?/init.lua"
local Prometheus = require("prometheus")

local Meloten = {}
Meloten.VERSION = "0.2.2"
Meloten.HEADER = "--[[\n" ..
    "This file was protected using Meloten Obfuscator v" .. Meloten.VERSION .. "\n" ..
    "Bot: https://t.me/Meloten_Obfuscatorbot\n" ..
    "Ultra-Stable Multi-Layer Protection\n" ..
    "]]"

Meloten.Presets = {
    Light = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 20}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = true,
                Shuffle = true,
                Rotate = true
            }},
        }
    },
    
    Medium = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 50}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "WrapInFunction"},
        }
    },
    
    Strong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = 0,
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    Extreme = {
        LuaVersion = "Lua51",
        VarNamePrefix = "_E_",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 999999),
        Steps = {
            {Name = "Vmify", Settings = {IntensityIndex = 150}},
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 2  -- Безопасное значение
            }},
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "WrapInFunction"},
            {Name = "EncryptStrings"},
        }
    },
    
    -- Ultra Strong - Стабильная версия
    UltraStrong = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 9999999),
        Steps = {
            -- Первая волна
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 2,  -- Консервативное значение
            }},
            
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            {Name = "NumbersToExpressions"},
            {Name = "EncryptStrings"},
            
            -- Двойная обёртка
            {Name = "WrapInFunction"},
            {Name = "WrapInFunction"},
            
            -- Вторая волна VM
            {Name = "Vmify", Settings = {IntensityIndex = 75}},
            
            -- Ещё константы (без LocalWrapper)
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
        }
    },
    
    -- Paranoid - ИСПРАВЛЕН (безопасные настройки)
    Paranoid = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 99999999),
        Steps = {
            -- Волна 1: Подготовка
            {Name = "NumbersToExpressions"},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            
            -- Волна 2: Первая VM
            {Name = "Vmify", Settings = {IntensityIndex = 100}},
            
            -- Волна 3: Константы (БЕЗОПАСНО)
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
                LocalWrapperTreshold = 1,
                LocalWrapperArgCount = 1,  -- МИНИМУМ для стабильности
            }},
            
            -- Волна 4: Шифрование
            {Name = "EncryptStrings"},
            
            -- Волна 5: Проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 6: Обёртка
            {Name = "WrapInFunction"},
            
            -- Волна 7: Вторая VM
            {Name = "Vmify", Settings = {IntensityIndex = 80}},
            
            -- Волна 8: Константы (без LocalWrapper)
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Волна 9: Вторая обёртка
            {Name = "WrapInFunction"},
            
            -- Волна 10: Третья VM
            {Name = "Vmify", Settings = {IntensityIndex = 60}},
            
            -- Волна 11: Проксирование
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 12: Третья обёртка
            {Name = "WrapInFunction"},
        }
    },
    
    -- Insane - МАКСИМАЛЬНО СТАБИЛЬНЫЙ
    Insane = {
        LuaVersion = "Lua51",
        VarNamePrefix = "",
        NameGenerator = "MangledShuffled",
        PrettyPrint = false,
        Seed = math.random(1, 999999999),
        Steps = {
            -- Волна 1-2: Подготовка
            {Name = "NumbersToExpressions"},
            {Name = "SplitStrings", Settings = {Treshold = 1}},
            
            -- Волна 3: Первая VM (умеренная)
            {Name = "Vmify", Settings = {IntensityIndex = 80}},
            
            -- Волна 4: Константы
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Волна 5: Шифрование
            {Name = "EncryptStrings"},
            
            -- Волна 6: Обёртка #1
            {Name = "WrapInFunction"},
            
            -- Волна 7: Вторая VM
            {Name = "Vmify", Settings = {IntensityIndex = 80}},
            
            -- Волна 8: Проксирование #1
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 9: Константы #2
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Волна 10: Обёртка #2
            {Name = "WrapInFunction"},
            
            -- Волна 11: Третья VM
            {Name = "Vmify", Settings = {IntensityIndex = 70}},
            
            -- Волна 12: Проксирование #2
            {Name = "ProxifyLocals", Settings = {Treshold = 1}},
            
            -- Волна 13: Константы #3
            {Name = "ConstantArray", Settings = {
                Treshold = 1,
                StringsOnly = false,
                Shuffle = true,
                Rotate = true,
            }},
            
            -- Волна 14: Обёртка #3
            {Name = "WrapInFunction"},
            
            -- Волна 15: Четвёртая VM (финальная)
            {Name = "Vmify", Settings = {IntensityIndex = 60}},
        }
    }
}

function Meloten.obfuscate(code, preset)
    preset = preset or "Medium"
    
    local config = Meloten.Presets[preset]
    if not config then
        error("Invalid preset: " .. preset)
    end
    
    if config.Seed > 0 then
        math.randomseed(config.Seed)
    else
        math.randomseed(os.time())
    end
    
    Prometheus.Logger.logLevel = Prometheus.Logger.LogLevel.Error
    
    local pipeline = Prometheus.Pipeline:fromConfig(config)
    local obfuscated = pipeline:apply(code)
    
    return Meloten.HEADER .. "\n\n" .. obfuscated
end

function Meloten.obfuscateFile(inputPath, outputPath, preset)
    local file = io.open(inputPath, "r")
    if not file then
        error("Cannot open input file: " .. inputPath)
    end
    
    local code = file:read("*all")
    file:close()
    
    local obfuscated = Meloten.obfuscate(code, preset)
    
    file = io.open(outputPath, "w")
    if not file then
        error("Cannot open output file: " .. outputPath)
    end
    
    file:write(obfuscated)
    file:close()
    
    print("✓ Successfully obfuscated: " .. inputPath .. " -> " .. outputPath)
end

return Meloten
